#!/usr/bin/env node
/**
 * Post-Orval script to generate index.ts for @/api/generated imports
 * This ensures Vite can resolve the directory import correctly
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const GENERATED_DIR = path.join(__dirname, '../src/api/generated');
const INDEX_FILE = path.join(GENERATED_DIR, 'index.ts');

console.log('ðŸ”§ Generating index.ts for @/api/generated...');

// Get all subdirectories (tags)
const entries = fs.readdirSync(GENERATED_DIR, { withFileTypes: true });
const tagDirs = entries
    .filter(entry => entry.isDirectory() && entry.name !== 'schemas')
    .map(entry => entry.name)
    .sort();

console.log(`ðŸ“ Found ${tagDirs.length} tag directories:`, tagDirs.join(', '));

// Generate exports
const exports = tagDirs.map(tag => `export * from './${tag}/${tag}';`).join('\n');

// Check if aliases.ts exists
const aliasesFile = path.join(GENERATED_DIR, 'aliases.ts');
const hasAliases = fs.existsSync(aliasesFile);

const indexContent = `/**
 * Auto-generated index file for Orval API
 * Generated by scripts/generate-api-index.mjs
 * DO NOT EDIT MANUALLY
 */

${exports}

// Re-export schemas
export * from './schemas';
${hasAliases ? `
// Re-export aliases for backward compatibility
export * from './aliases';
` : ''}
`;

// Write index file
fs.writeFileSync(INDEX_FILE, indexContent, 'utf-8');

console.log('âœ… Generated index.ts successfully!');
console.log(`ðŸ“„ File: ${INDEX_FILE}`);
console.log(`ðŸ“¦ Exports: ${tagDirs.length} tags + schemas`);
