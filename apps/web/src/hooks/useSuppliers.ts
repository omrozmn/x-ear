import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getXEarCRMAPIAutoGenerated } from '@/api/generated/xEarCRMAPIAutoGenerated';
import type { Supplier } from '@/api/generated/xEarCRMAPIAutoGenerated.schemas.ts/supplier';
import type { SupplierStatus } from '@/api/generated/xEarCRMAPIAutoGenerated.schemas.ts/supplierStatus';
import type { SuppliersCreateSupplierBody } from '@/api/generated/xEarCRMAPIAutoGenerated.schemas.ts/suppliersCreateSupplierBody';
import type { SuppliersGetSuppliersParams } from '@/api/generated/xEarCRMAPIAutoGenerated.schemas.ts/suppliersGetSuppliersParams';

const api = getXEarCRMAPIAutoGenerated();

export const useSuppliers = (params: SuppliersGetSuppliersParams) => {
  return useQuery({
    queryKey: ['suppliers', params], 
    queryFn: () => api.suppliersGetSuppliers(params),
    placeholderData: (previousData, previousQuery) => previousData,
  });
};

export const useSupplier = (id: string) => {
  return useQuery({
    queryKey: ['suppliers', id],
    queryFn: () => api.suppliersGetSuppliers({ search: id }),
    enabled: !!id,
    select: (data) => data.data?.data?.find(s => s.id === id),
  });
};

async function makeIdempotencyKey(prefix: string, body: unknown) {
  const json = JSON.stringify(body ?? {});
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(json));
  const hex = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  return `${prefix}:${hex}`;
}

export const useCreateSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (newSupplier: SuppliersCreateSupplierBody) => {
      const key = await makeIdempotencyKey('suppliers:create', newSupplier);
      return api.suppliersCreateSupplier(newSupplier, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

export const useUpdateSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ supplierId, updates }: { supplierId: string; updates: SuppliersCreateSupplierBody }) => {
      const key = await makeIdempotencyKey('suppliers:update', { supplierId, ...updates });
      // TODO: Use proper update endpoint when available
      return api.suppliersCreateSupplier(updates, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

export const useDeleteSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (id: string) => api.suppliersDeleteSupplier(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};