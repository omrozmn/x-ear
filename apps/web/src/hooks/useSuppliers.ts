import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getXEarCRMAPIAutoGenerated } from '@/api/generated/xEarCRMAPIAutoGenerated';
import { outbox } from '@/utils/outbox';
import type {
  Supplier,
  SuppliersCreateSupplierBody,
  SuppliersGetSuppliersParams,
  SuppliersGetSupplierInvoicesParams
} from '@/api/generated/schemas';

const api = getXEarCRMAPIAutoGenerated();

export const useSuppliers = (params: SuppliersGetSuppliersParams) => {
  return useQuery({
    queryKey: ['suppliers', params],
    queryFn: () => api.suppliersGetSuppliers(params),
    placeholderData: (previousData, previousQuery) => previousData,
  });
};

export const useSupplier = (id: string) => {
  return useQuery({
    queryKey: ['suppliers', id],
    queryFn: () => api.suppliersGetSuppliers({ search: id }),
    enabled: !!id,
    select: (data) => data.data?.data?.find(s => String(s.id) === String(id) || (s as any)._id === id),
  });
};

async function makeIdempotencyKey(prefix: string, body: unknown) {
  const json = JSON.stringify(body ?? {});
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(json));
  const hex = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  return `${prefix}:${hex}`;
}

export const useCreateSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (newSupplier: SuppliersCreateSupplierBody) => {
      // Transform to snake_case for backend
      const payload = {
        company_name: newSupplier.companyName,
        company_code: newSupplier.companyCode,
        tax_number: newSupplier.taxNumber,
        tax_office: newSupplier.taxOffice,
        contact_person: newSupplier.contactPerson,
        email: newSupplier.email,
        phone: newSupplier.phone,
        mobile: newSupplier.mobile,
        website: newSupplier.website,
        address: newSupplier.address,
        city: newSupplier.city,
        country: newSupplier.country,
        postal_code: newSupplier.postalCode,
        payment_terms: newSupplier.paymentTerms,
        currency: newSupplier.currency,
        rating: newSupplier.rating,
        notes: newSupplier.notes,
        is_active: newSupplier.isActive
      };

      const key = await makeIdempotencyKey('suppliers:create', payload);
      return api.suppliersCreateSupplier(payload, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

export const useUpdateSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ supplierId, updates }: { supplierId: string; updates: SuppliersCreateSupplierBody }) => {
      // Transform to snake_case for backend
      const payload = {
        company_name: updates.companyName,
        company_code: updates.companyCode,
        tax_number: updates.taxNumber,
        tax_office: updates.taxOffice,
        contact_person: updates.contactPerson,
        email: updates.email,
        phone: updates.phone,
        mobile: updates.mobile,
        website: updates.website,
        address: updates.address,
        city: updates.city,
        country: updates.country,
        postal_code: updates.postalCode,
        payment_terms: updates.paymentTerms,
        currency: updates.currency,
        rating: updates.rating,
        notes: updates.notes,
        is_active: updates.isActive
      };

      const key = await makeIdempotencyKey('suppliers:update', { supplierId, ...payload });
      await outbox.addOperation({
        method: 'PUT',
        endpoint: `/api/suppliers/${supplierId}`,
        data: payload,
        headers: { 'Idempotency-Key': key },
        priority: 'high'
      });
      return api.suppliersUpdateSupplier(supplierId, payload, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

export const useDeleteSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (id: string) => api.suppliersDeleteSupplier(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

interface SupplierProductsResponse {
  data: {
    products: Array<{
      id: string;
      supplier_product_name?: string;
      supplier_product_code?: string;
      unit_cost?: number;
      currency?: string;
      lead_time_days?: number;
      product?: {
        name: string;
        sku?: string;
      };
    }>;
  };
}

export const useSupplierProducts = (supplierId: string) => {
  return useQuery<SupplierProductsResponse>({
    queryKey: ['supplier-products', supplierId],
    queryFn: () => api.suppliersGetSupplierProducts(supplierId) as Promise<SupplierProductsResponse>,
    enabled: !!supplierId,
  });
};

export const useSupplierInvoices = (
  supplierId: string,
  params?: SuppliersGetSupplierInvoicesParams
) => {
  return useQuery({
    queryKey: ['supplier-invoices', supplierId, params],
    queryFn: () => api.suppliersGetSupplierInvoices(supplierId, params),
    enabled: !!supplierId,
    placeholderData: (previousData) => previousData,
  });
};

export const useSuggestedSuppliers = () => {
  return useQuery({
    queryKey: ['suggested-suppliers'],
    queryFn: () => api.suppliersGetSuggestedSuppliers(),
    placeholderData: (previousData) => previousData,
  });
};

export const useAcceptSuggestedSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (suggestedId: string) => {
      const key = await makeIdempotencyKey('suppliers:suggested:accept', { suggestedId });
      await outbox.addOperation({
        method: 'POST',
        endpoint: `/api/suppliers/suggested/${suggestedId}/accept`,
        headers: { 'Idempotency-Key': key },
        priority: 'high'
      });
      return api.suppliersAcceptSuggestedSupplier(suggestedId, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suggested-suppliers'] });
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

export const useRejectSuggestedSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (suggestedId: string) => {
      await outbox.addOperation({
        method: 'DELETE',
        endpoint: `/api/suppliers/suggested/${suggestedId}`,
        priority: 'normal'
      });
      return api.suppliersRejectSuggestedSupplier(suggestedId);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suggested-suppliers'] });
    },
  });
};

export const useSyncBirFaturaInvoices = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (params?: { startDate?: string; endDate?: string }) => {
      const payload = params
        ? { start_date: params.startDate, end_date: params.endDate }
        : undefined;
      const key = await makeIdempotencyKey('birfatura:sync', payload ?? {});
      await outbox.addOperation({
        method: 'POST',
        endpoint: `/api/birfatura/sync-invoices`,
        headers: { 'Idempotency-Key': key },
        data: payload,
        priority: 'high'
      });
      return api.birfaturaSyncInvoices(payload as any, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['supplier-invoices'] });
    },
  });
};
