import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getXEarCRMAPIAutoGenerated } from '@/api/generated/xEarCRMAPIAutoGenerated';
import { outbox } from '@/utils/outbox';
import type { SuppliersGetSupplierInvoicesParams } from '@/api/generated/schemas';

const api = getXEarCRMAPIAutoGenerated();

async function makeIdempotencyKey(prefix: string, body: unknown) {
  const json = JSON.stringify(body ?? {});
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(json));
  const hex = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  return `${prefix}:${hex}`;
}

export const useSupplierInvoices = (params: { supplierId: string } & SuppliersGetSupplierInvoicesParams) => {
  return useQuery({
    queryKey: ['supplier-invoices', params],
    queryFn: () => api.suppliersGetSupplierInvoices(params.supplierId, params),
    enabled: !!params.supplierId,
    placeholderData: (prev) => prev,
  });
};

export const useSuggestedSuppliers = () => {
  return useQuery({
    queryKey: ['suggested-suppliers'],
    queryFn: () => api.suppliersGetSuggestedSuppliers(),
    placeholderData: (prev) => prev,
  });
};

export const useAcceptSuggestedSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (suggestedId: number | string) => {
      const key = await makeIdempotencyKey('suppliers:suggested:accept', { suggestedId });
      await outbox.addOperation({
        method: 'POST',
        endpoint: `/api/suppliers/suggested/${suggestedId}/accept`,
        headers: { 'Idempotency-Key': key },
        priority: 'high'
      });
      return api.suppliersAcceptSuggestedSupplier(String(suggestedId), { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suggested-suppliers'] });
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
    },
  });
};

export const useRejectSuggestedSupplier = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (suggestedId: number | string) => {
      await outbox.addOperation({
        method: 'DELETE',
        endpoint: `/api/suppliers/suggested/${suggestedId}`,
        priority: 'normal'
      });
      return api.suppliersRejectSuggestedSupplier(String(suggestedId));
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suggested-suppliers'] });
    },
  });
};

export const useSyncInvoices = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (params?: { startDate?: string; endDate?: string }) => {
      const payload = params ? { start_date: params.startDate, end_date: params.endDate } : undefined;
      const key = await makeIdempotencyKey('birfatura:sync', payload ?? {});
      await outbox.addOperation({
        method: 'POST',
        endpoint: `/api/birfatura/sync-invoices`,
        headers: { 'Idempotency-Key': key },
        data: payload,
        priority: 'high'
      });
      return api.birfaturaSyncInvoices(payload as any, { headers: { 'Idempotency-Key': key } });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['supplier-invoices'] });
      queryClient.invalidateQueries({ queryKey: ['suggested-suppliers'] });
    },
  });
};
