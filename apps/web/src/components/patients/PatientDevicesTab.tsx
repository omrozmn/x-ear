import React, { useState, useEffect, useCallback } from 'react';
import { Button, Input, Select, Badge } from '@x-ear/ui-web';
import { FileText, Plus, Calendar, DollarSign, Settings, Trash2, Edit, X, XCircle } from 'lucide-react';
import { Patient } from '../../types/patient';
import { inventoryGetInventoryItems, inventoryAssignToPatient, devicesCreateDevice, devicesDeleteDevice } from '../../api/generated/xEarCRMAPIAutoGenerated';
import type {
  Device,
  /* DevicesGetDevicesParams, */
  DevicesCreateDeviceBody,
  InventoryItem,
  InventoryGetInventoryItemsParams,
  InventoryAssignToPatientBody,
  Sale,
  SalesCreateSaleBody
} from '../../api/generated/schemas';
import DeviceEditModal from './modals/DeviceEditModal';
import DeviceReplacementHistory from '../DeviceReplacementHistory';
import { usePatientDevices } from '../../hooks/patient/usePatientDevices';

interface PatientDevicesTabProps {
  patient: Patient;
  onPatientUpdate?: (patient: Patient) => void;
}

export const PatientDevicesTab: React.FC<PatientDevicesTabProps> = ({ patient }: PatientDevicesTabProps) => {

  const [showDeviceForm, setShowDeviceForm] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [editingDevice, setEditingDevice] = useState<Device | null>(null);
  const [rightEarMode, setRightEarMode] = useState<'inventory' | 'manual'>('inventory');
  const [leftEarMode, setLeftEarMode] = useState<'inventory' | 'manual'>('manual');
  const [rightEarReason, setRightEarReason] = useState<'Trial' | 'Sale'>('Trial');
  const [leftEarReason, setLeftEarReason] = useState<'Trial' | 'Sale'>('Trial');

  // Use the hook for patient devices
  // Cast to `any` because backend device shape has evolved (serialNumberLeft/Right etc.)
  const { data: devices, isLoading: devicesLoading, error: devicesError, refetch: refetchDevices } = usePatientDevices(patient?.id || '') as any;

  // State for other API data
  const [inventoryItems, setInventoryItems] = useState<InventoryItem[]>([]);
  const [sales, setSales] = useState<Sale[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const loadInventoryItems = useCallback(async () => {
    try {
      const params: InventoryGetInventoryItemsParams = {
        page: 1,
        per_page: 20, // Reduced from 100 to 20 to minimize data transfer
        status: 'IN_STOCK'
      };

      const response = await inventoryGetInventoryItems(params);
      setInventoryItems(response.data?.data || []);
    } catch (err) {
      console.error('Error loading inventory:', err);
    }
  }, []);

  const loadPatientSales = useCallback(async () => {
    if (!patient.id) return;

    try {
      // Note: This would need to be filtered by patient ID in a real implementation
      // For now, we'll use mock data structure
      setSales([]);
    } catch (err) {
      console.error('Error loading patient sales:', err);
    }
  }, [patient.id]);

  // Load data on component mount (effect defined after callbacks)
  useEffect(() => {
    loadInventoryItems();
    loadPatientSales();
  }, [loadInventoryItems, loadPatientSales]);

  const handleAssignDevice = async (deviceData: Record<string, unknown>) => {
    try {
      setLoading(true);

      if (deviceData.mode === 'inventory') {
        // Assign from inventory
        const assignData: InventoryAssignToPatientBody = {
          patientId: patient.id,
          quantity: 1,
          reason: deviceData.reason
        };

        await inventoryAssignToPatient(deviceData.inventoryId as string, assignData);
      } else {
        // Create new device manually
        const createData: DevicesCreateDeviceBody = {
          patientId: patient.id,
          serialNumber: deviceData.serialNumber as string,
          brand: deviceData.brand as string,
          model: deviceData.model as string,
          deviceType: deviceData.deviceType as string,
          ear: deviceData.ear as string,
          status: deviceData.reason === 'Trial' ? 'assigned' : 'assigned'
        };

        await devicesCreateDevice(createData);
      }

      // If it's a sale, create sale record
      if (deviceData.reason === 'Sale') {
        // Assuming a salesCreateSale function exists; import if needed.
        const saleData: SalesCreateSaleBody = {
          patientId: patient.id,
          deviceId: deviceData.deviceId as string,
          amount: deviceData.salePrice as number,
          paymentMethod: deviceData.paymentMethod as string,
          notes: `${deviceData.brand} ${deviceData.model} satışı`
        };

        // TODO: implement salesCreateSale import and call.
        // await salesCreateSale(saleData);
      }

      await refetchDevices();
      await loadPatientSales();
      setShowDeviceForm(false);
      setError(null);
    } catch (err) {
      console.error('Error assigning device:', err);
      setError('Cihaz atanırken hata oluştu');
    } finally {
      setLoading(false);
    }
  };

  const handleRemoveDevice = async (deviceId: string) => {
    try {
      await devicesDeleteDevice(deviceId);
      await refetchDevices();
    } catch (err) {
      console.error('Error removing device:', err);
      setError('Cihaz kaldırılırken hata oluştu');
    }
  };

  const handleEditDevice = (device: Device) => {
    setEditingDevice(device);
    setShowEditModal(true);
  };

  const handleUpdateDevice = async (deviceId: string, updates: Partial<Device>) => {
    if (!deviceId) return;

    try {
      setLoading(true);
      +      void updates;

      // Note: This assumes there's an update method in the API
      // await devicesApi.devicesUpdateDevice(deviceId, updates);

      // For now, just refresh the devices list
      await refetchDevices();
      setShowEditModal(false);
      setEditingDevice(null);
      setError(null);
    } catch (error) {
      console.error('Error updating device:', error);
      setError('Cihaz güncellenirken hata oluştu');
    } finally {
      setLoading(false);
    }
  };

  const handleReplaceDevice = async (oldDeviceId: string, reasonOrData: any, maybeNotes?: string, maybeNewInventoryId?: string, maybeNewDeviceInfo?: any) => {
    try {
      setLoading(true);

      // Normalize parameters (support both old and new signatures)
      let reason = 'other';
      let notes: string | undefined = undefined;
      let newInventoryId: string | undefined = undefined;
      let newDeviceInfo: any = undefined;
      if (typeof reasonOrData === 'object') {
        // legacy call used single object
        const obj = reasonOrData || {};
        reason = obj.reason || obj.replacementReason || 'other';
        notes = obj.notes || undefined;
        newInventoryId = obj.inventoryId as string | undefined;
        newDeviceInfo = obj;
      } else {
        reason = reasonOrData || 'other';
        notes = maybeNotes;
        newInventoryId = maybeNewInventoryId;
        newDeviceInfo = maybeNewDeviceInfo;
      }

      // Create replacement record on server before mutating devices
      try {
        const oldDevice = (devices || []).find((d: any) => d.id === oldDeviceId) || { id: oldDeviceId };
        const payload: any = {
          oldDeviceId,
          oldDeviceInfo: {
            id: oldDevice.id,
            brand: oldDevice.brand,
            model: oldDevice.model,
            serialNumber: oldDevice.serialNumber || oldDevice.serialNumberLeft || oldDevice.serialNumberRight || undefined
          },
          newInventoryId: newInventoryId,
          newDeviceInfo: newDeviceInfo,
          replacementReason: reason,
          notes: notes
        };

        const resp = await authFetch(`/api/patients/${patient.id}/replacements`, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        // Read server response for improved error messages (e.g. Missing Authorization Header)
        const j = await resp.json().catch(() => null);
        if (!resp.ok) {
          const errMsg = (j && (j.error || j.msg || j.message)) || `Server ${resp.status}`;
          throw new Error(errMsg);
        }
      } catch (e) {
        // Surface backend error to user and abort replace flow
        console.error('Error creating replacement on server:', e);
        throw e;
      }

      // Remove old device
      await handleRemoveDevice(oldDeviceId);

      // Add new device (from inventory or manual)
      await handleAssignDevice({ inventoryId: newInventoryId, reason, ...newDeviceInfo });

      setError(null);
    } catch (err) {
      console.error('Error replacing device:', err);
      setError('Cihaz değiştirilirken hata oluştu');
    } finally {
      setLoading(false);
    }
  };

  // Helper: perform authenticated fetch against backend proxy so Authorization header is included
  const authFetch = async (path: string, opts: RequestInit = {}) => {
    const headers: HeadersInit = {
      'Content-Type': 'application/json',
      ...(opts.headers || {}),
    };

    let token: string | null = null;
    try {
      if (typeof window !== 'undefined') {
        token = (window as any).__AUTH_TOKEN__ || localStorage.getItem('x-ear.auth.token@v1') || localStorage.getItem('auth_token');
      }
    } catch (e) {
      token = null;
    }
    if (token) {
      (headers as any).Authorization = `Bearer ${token}`;
    }

    const res = await fetch(`${path}`, { credentials: 'same-origin', ...opts, headers });
    return res;
  };

  // Calculate quick stats from loaded data
  const quickStats = {
    activeDevices: devices.filter(d => d.status === 'assigned').length,
    trials: devices.filter(d => d.trialStartDate).length,
    totalValue: sales.reduce((sum, s) => sum + (s.totalAmount || 0), 0),
    ereceiptsCount: 0 // This would come from a separate API
  };

  const getDeviceStatusBadge = (status?: string) => {
    switch (status) {
      case 'assigned':
        return <Badge className="bg-green-100 text-green-800">Atanmış</Badge>;
      case 'available':
        return <Badge className="bg-blue-100 text-blue-800">Müsait</Badge>;
      case 'maintenance':
        return <Badge className="bg-yellow-100 text-yellow-800">Bakımda</Badge>;
      case 'retired':
        return <Badge className="bg-gray-100 text-gray-800">Emekli</Badge>;
      default:
        return <Badge className="bg-gray-100 text-gray-800">Bilinmiyor</Badge>;
    }
  };

  const getEarText = (ear?: string) => {
    switch (ear) {
      case 'left':
        return 'Sol';
      case 'right':
        return 'Sağ';
      case 'both':
        return 'İkisi';
      default:
        return 'Belirtilmemiş';
    }
  };

  const formatCurrencyTR = (amount?: number) => {
    try {
      return (Number(amount || 0)).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' TRY';
    } catch (e) {
      return `${Number(amount || 0).toFixed(2)} TRY`;
    }
  };

  if (loading && devices.length === 0) {
    return (
      <div className="flex items-center justify-center py-8">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Cihazlar yükleniyor...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-4 rounded-lg shadow-sm border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Aktif Cihaz</p>
              <p className="text-2xl font-bold text-green-600">{quickStats.activeDevices}</p>
            </div>
            <div className="p-2 bg-green-100 rounded-full">
              <Settings className="w-6 h-6 text-green-600" />
            </div>
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow-sm border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Deneme</p>
              <p className="text-2xl font-bold text-blue-600">{quickStats.trials}</p>
            </div>
            <div className="p-2 bg-blue-100 rounded-full">
              <Calendar className="w-6 h-6 text-blue-600" />
            </div>
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow-sm border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">Toplam Değer</p>
              <p className="text-2xl font-bold text-purple-600">₺{quickStats.totalValue.toLocaleString()}</p>
            </div>
            <div className="p-2 bg-purple-100 rounded-full">
              <DollarSign className="w-6 h-6 text-purple-600" />
            </div>
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow-sm border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">E-Reçete</p>
              <p className="text-2xl font-bold text-orange-600">{quickStats.ereceiptsCount}</p>
            </div>
            <div className="p-2 bg-orange-100 rounded-full">
              <FileText className="w-6 h-6 text-orange-600" />
            </div>
          </div>
        </div>
      </div>

      {/* Header with Add Device Button */}
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-medium text-gray-900">Atanmış Cihazlar</h3>
        <Button
          onClick={() => setShowDeviceForm(true)}
          className="inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
          aria-label="Cihaz ata"
        >
          <Plus className="w-5 h-5" />
        </Button>
      </div>

      {/* Error Message */}
      {(error || devicesError) && (
        <div className="bg-red-50 border border-red-200 rounded-md p-4">
          <div className="flex">
            <XCircle className="h-5 w-5 text-red-400" />
            <div className="ml-3">
              <p className="text-sm text-red-800">{error || devicesError}</p>
            </div>
          </div>
        </div>
      )}

      {/* Devices List */}
      <div className="space-y-4">
        {devices.length > 0 ? (
          devices.map((device) => (
            <div key={device.id} className="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center space-x-3 mb-2">
                    <Settings className="w-5 h-5 text-blue-500" />
                    <div>
                      <p className="font-medium text-gray-900">
                        {device.brand} {device.model}
                      </p>
                      <div className="text-sm text-gray-600">
                        {device.serialNumberLeft && device.serialNumberRight ? (
                          <div className="flex items-center gap-3">
                            <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-50 text-red-700 border border-red-200">
                              Sağ: {device.serialNumberRight}
                            </span>
                            <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                              Sol: {device.serialNumberLeft}
                            </span>
                          </div>
                        ) : device.serialNumberLeft ? (
                          <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                            Sol: {device.serialNumberLeft}
                          </span>
                        ) : device.serialNumberRight ? (
                          <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-50 text-red-700 border border-red-200">
                            Sağ: {device.serialNumberRight}
                          </span>
                        ) : device.serialNumber ? (
                          <span>Seri No: {device.serialNumber}</span>
                        ) : (
                          <span className="text-gray-400 italic">Seri no atanmamış</span>
                        )}
                      </div>
                    </div>
                    {getDeviceStatusBadge(device.status)}
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                    <div>
                      <strong>Kulak:</strong> {getEarText(device.ear)}
                    </div>
                    <div>
                      <strong>Tip:</strong> {device.deviceType || 'Belirtilmemiş'}
                    </div>
                    {device.trialStartDate && (
                      <div>
                        <strong>Deneme Başlangıcı:</strong> {new Date(device.trialStartDate).toLocaleDateString('tr-TR')}
                      </div>
                    )}
                    {device.trialEndDate && (
                      <div>
                        <strong>Deneme Bitişi:</strong> {new Date(device.trialEndDate).toLocaleDateString('tr-TR')}
                      </div>
                    )}
                  </div>

                  {device.notes && (
                    <div className="mt-2">
                      <p className="text-sm text-gray-600">
                        <strong>Notlar:</strong> {device.notes}
                      </p>
                    </div>
                  )}

                  {/* Show sale price; if bilateral, multiply by 2 and mark as (Bilateral) */}
                  <div className="mt-3">
                    <p className="text-sm text-gray-700">
                      <strong>Satış Fiyatı:</strong>{' '}
                      {device.ear === 'both'
                        ? (
                          <>
                            {formatCurrencyTR((device.salePrice || device.price || 0) * 2)}{' '}
                            <span className="text-xs text-purple-600">(Bilateral)</span>
                          </>
                        )
                        : formatCurrencyTR(device.salePrice || device.price || 0)
                      }
                    </p>
                  </div>
                  {/* SGK Desteği: per-ear hesaplama (uyumlu hale getirildi) */}
                  {(() => {
                    try {
                      const dp: any = device as any;
                      const earVal = (dp.ear || dp.earSide || dp.ear_side || '').toString().toLowerCase();
                      const qty = (earVal.startsWith('b') || earVal === 'both' || earVal === 'bilateral') ? 2 : 1;

                      const rawSgk = dp.sgkSupport ?? dp.sgk_support ?? dp.sgkReduction ?? dp.sgk_reduction ?? dp.sgk_coverage_amount ?? null;
                      if (rawSgk !== null && rawSgk !== undefined) {
                        console.log('[PatientDevicesTab] deviceId=', dp.id || dp.deviceId || dp.assignmentId, 'ear=', earVal, 'rawSgk=', rawSgkNum, 'qty=', qty, 'compareBase=', compareBase);
                        const rawSgkNum = Number(rawSgk);
                        let perUnit = rawSgkNum;
                        const compareBase = Number(dp.salePrice ?? dp.sale_price ?? dp.listPrice ?? dp.list_price ?? dp.netPayable ?? dp.net_payable ?? 0);
                        if (qty > 1 && compareBase > 0 && rawSgkNum > compareBase * 1.1) {
                          perUnit = rawSgkNum / qty;
                        }

                        console.log('[PatientDevicesTab] computed perUnit=', perUnit);

                        return (
                          <div className="mt-2">
                            <p className="text-sm text-green-600"><strong>SGK Desteği:</strong> {formatCurrencyTR(perUnit)}</p>
                          </div>
                        );
                      }
                    } catch (e) {
                      // ignore
                    }
                    return null;
                  })()}
                </div>

                <div className="flex items-center space-x-2 ml-4">
                  <Button
                    onClick={() => handleEditDevice(device)}
                    className="p-2 text-gray-600 hover:bg-gray-50"
                    title="Düzenle"
                  >
                    <Edit className="w-4 h-4" />
                  </Button>
                  <Button
                    onClick={() => device.id && handleRemoveDevice(device.id)}
                    className="p-2 text-red-600 hover:bg-red-50"
                    title="Kaldır"
                  >
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div className="text-center py-8 text-gray-500">
            <Settings className="w-12 h-12 mx-auto mb-4 text-gray-300" />
            <p>Henüz atanmış cihaz bulunmamaktadır.</p>
          </div>
        )}
      </div>

      {/* Device Replacement History */}
      <DeviceReplacementHistory
        patientId={patient.id || ''}
        className="mt-6"
      />

      {/* Device Assignment Form Modal */}
      {showDeviceForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[85vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-lg font-medium">Cihaz Atama</h3>
              <Button
                onClick={() => setShowDeviceForm(false)}
                className="p-1 text-gray-400 hover:text-gray-600"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>

            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.currentTarget);

              // Process right ear data
              if (formData.get('rightEarEnabled')) {
                const rightEarData = {
                  mode: rightEarMode,
                  ear: 'right',
                  reason: rightEarReason,
                  inventoryId: formData.get('rightInventoryId'),
                  brand: formData.get('rightBrand'),
                  model: formData.get('rightModel'),
                  serialNumber: formData.get('rightSerialNumber'),
                  deviceType: formData.get('rightDeviceType'),
                  salePrice: formData.get('rightSalePrice'),
                  paymentMethod: formData.get('rightPaymentMethod')
                };
                handleAssignDevice(rightEarData);
              }

              // Process left ear data
              if (formData.get('leftEarEnabled')) {
                const leftEarData = {
                  mode: leftEarMode,
                  ear: 'left',
                  reason: leftEarReason,
                  inventoryId: formData.get('leftInventoryId'),
                  brand: formData.get('leftBrand'),
                  model: formData.get('leftModel'),
                  serialNumber: formData.get('leftSerialNumber'),
                  deviceType: formData.get('leftDeviceType'),
                  salePrice: formData.get('leftSalePrice'),
                  paymentMethod: formData.get('leftPaymentMethod')
                };
                handleAssignDevice(leftEarData);
              }
            }}>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Right Ear */}
                <div className="space-y-4">
                  <div className="flex items-center space-x-2">
                    <Input type="checkbox" name="rightEarEnabled" id="rightEarEnabled" defaultChecked />
                    <label htmlFor="rightEarEnabled" className="font-medium text-gray-900">Sağ Kulak</label>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Mod</label>
                    <Select
                      value={rightEarMode}
                      onChange={(e) => setRightEarMode(e.target.value as 'inventory' | 'manual')}
                      options={[
                        { value: 'inventory', label: 'Envanterden Seç' },
                        { value: 'manual', label: 'Manuel Giriş' }
                      ]}
                      className="w-full"
                    />
                  </div>

                  {rightEarMode === 'inventory' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Cihaz Seç</label>
                      <Select
                        name="rightInventoryId"
                        options={[
                          { value: '', label: 'Cihaz seçiniz...' },
                          ...inventoryItems.filter(item => item.id).map((item) => ({
                            value: item.id!,
                            label: `${item.name} - ${item.brand} ${item.model} (Stok: ${item.availableInventory || 0})`
                          }))
                        ]}
                        className="w-full"
                      />
                    </div>
                  )}

                  {rightEarMode === 'manual' && (
                    <div className="space-y-3">
                      <Input name="rightBrand" placeholder="Marka" required />
                      <Input name="rightModel" placeholder="Model" required />
                      <Input name="rightSerialNumber" placeholder="Seri No" required />
                      <Input name="rightDeviceType" placeholder="Tip" />
                    </div>
                  )}

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Sebep</label>
                    <Select
                      value={rightEarReason}
                      onChange={(e) => setRightEarReason(e.target.value as 'Trial' | 'Sale')}
                      options={[
                        { value: 'Trial', label: 'Deneme' },
                        { value: 'Sale', label: 'Satış' }
                      ]}
                      className="w-full"
                    />
                  </div>

                  {rightEarReason === 'Sale' && (
                    <div className="space-y-3 p-4 bg-gray-50 rounded-lg">
                      <h5 className="font-medium text-gray-900">Fiyatlandırma</h5>
                      <Input name="rightListPrice" type="number" placeholder="Liste Fiyatı" />
                      <Input name="rightSalePrice" type="number" placeholder="Satış Fiyatı" required />
                      <Select
                        name="rightPaymentMethod"
                        options={[
                          { value: '', label: 'Ödeme Yöntemi' },
                          { value: 'cash', label: 'Nakit' },
                          { value: 'credit', label: 'Kredi Kartı' },
                          { value: 'installment', label: 'Taksit' }
                        ]}
                        className="w-full"
                      />
                    </div>
                  )}
                </div>

                {/* Left Ear */}
                <div className="space-y-4">
                  <div className="flex items-center space-x-2">
                    <Input type="checkbox" name="leftEarEnabled" id="leftEarEnabled" />
                    <label htmlFor="leftEarEnabled" className="font-medium text-gray-900">Sol Kulak</label>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Mod</label>
                    <Select
                      value={leftEarMode}
                      onChange={(e) => setLeftEarMode(e.target.value as 'inventory' | 'manual')}
                      options={[
                        { value: 'inventory', label: 'Envanterden Seç' },
                        { value: 'manual', label: 'Manuel Giriş' }
                      ]}
                      className="w-full"
                    />
                  </div>

                  {leftEarMode === 'inventory' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Cihaz Seç</label>
                      <Select
                        name="leftInventoryId"
                        options={[
                          { value: '', label: 'Cihaz seçiniz...' },
                          ...inventoryItems.filter(item => item.id).map((item) => ({
                            value: item.id!,
                            label: `${item.name} - ${item.brand} ${item.model} (Stok: ${item.availableInventory || 0})`
                          }))
                        ]}
                        className="w-full"
                      />
                    </div>
                  )}

                  {leftEarMode === 'manual' && (
                    <div className="space-y-3">
                      <Input name="leftBrand" placeholder="Marka" required />
                      <Input name="leftModel" placeholder="Model" required />
                      <Input name="leftSerialNumber" placeholder="Seri No" required />
                      <Input name="leftDeviceType" placeholder="Tip" />
                    </div>
                  )}

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Sebep</label>
                    <Select
                      value={leftEarReason}
                      onChange={(e) => setLeftEarReason(e.target.value as 'Trial' | 'Sale')}
                      options={[
                        { value: 'Trial', label: 'Deneme' },
                        { value: 'Sale', label: 'Satış' }
                      ]}
                      className="w-full"
                    />
                  </div>

                  {leftEarReason === 'Sale' && (
                    <div className="space-y-3 p-4 bg-gray-50 rounded-lg">
                      <h5 className="font-medium text-gray-900">Fiyatlandırma</h5>
                      <Input name="leftListPrice" type="number" placeholder="Liste Fiyatı" />
                      <Input name="leftSalePrice" type="number" placeholder="Satış Fiyatı" required />
                      <Select
                        name="leftPaymentMethod"
                        options={[
                          { value: '', label: 'Ödeme Yöntemi' },
                          { value: 'cash', label: 'Nakit' },
                          { value: 'credit', label: 'Kredi Kartı' },
                          { value: 'installment', label: 'Taksit' }
                        ]}
                        className="w-full"
                      />
                    </div>
                  )}
                </div>
              </div>

              <div className="flex justify-end space-x-3 mt-6">
                <Button
                  type="button"
                  onClick={() => setShowDeviceForm(false)}
                  className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md"
                >
                  İptal
                </Button>
                <Button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md"
                  disabled={loading || devicesLoading}
                >
                  {(loading || devicesLoading) ? 'Atanıyor...' : 'Cihaz Ata'}
                </Button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Device Edit Modal */}
      <DeviceEditModal
        isOpen={showEditModal}
        onClose={() => {
          setShowEditModal(false);
          setEditingDevice(null);
        }}
        device={editingDevice}
        inventoryItems={inventoryItems}
        onUpdate={handleUpdateDevice}
        onReplace={handleReplaceDevice}
        loading={loading || devicesLoading}
      />
    </div>
  );
};