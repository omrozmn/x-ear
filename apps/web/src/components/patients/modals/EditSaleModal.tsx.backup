import React, { useState, useEffect } from 'react';
import { 
  Button, 
  Input, 
  Label, 
  Textarea,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  Badge,
  Alert,
  Loading
} from '@x-ear/ui-web';
import { X, Edit, DollarSign, CreditCard, AlertCircle, CheckCircle, Package, Search, Settings, FileText, Calendar, Wrench } from 'lucide-react';
import { Patient } from '../../../types/patient';
import { Sale, SalesUpdateSaleBody, InventoryItem } from '../../../api/generated/xEarCRMAPIAutoGenerated.schemas';
import { 
  getXEarCRMAPIAutoGenerated
} from '../../../api/generated/xEarCRMAPIAutoGenerated';
import PaymentTrackingModal from '../../payments/PaymentTrackingModal';
import { PaymentSummary } from './PaymentSummary';
import { SGKIntegration } from './SGKIntegration';
import { SaleFormFields } from './SaleFormFields';

interface EditSaleModalProps {
  isOpen: boolean;
  onClose: () => void;
  patient: Patient;
  sale: Sale;
  onSaleUpdate: (sale: Sale) => void;
  loading?: boolean;
}

// Payment record type
interface PaymentRecord {
  id: string;
  amount: number;
  paymentDate: string;
  paymentMethod: string;
  notes?: string;
  status: 'pending' | 'completed' | 'cancelled';
}

// SGK Scheme types
interface SGKScheme {
  id: string;
  name: string;
  code: string;
  coveragePercentage: number;
  maxAmount?: number;
  description?: string;
}

// Service types
interface ServiceInfo {
  type: 'warranty' | 'maintenance' | 'repair' | 'calibration' | 'fitting';
  description: string;
  duration?: number; // in months
  cost?: number;
  notes?: string;
}

export const EditSaleModal: React.FC<EditSaleModalProps> = ({
  isOpen,
  onClose,
  patient,
  sale,
  onSaleUpdate,
  loading = false
}) => {
  const [saleType, setSaleType] = useState<'device' | 'service' | 'accessory'>('device');
  const [paymentMethod, setPaymentMethod] = useState<string>('cash');
  const [installmentCount, setInstallmentCount] = useState(1);
  const [saleStatus, setSaleStatus] = useState<string>('draft');
  const [hasChanges, setHasChanges] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [productDetails, setProductDetails] = useState<InventoryItem | null>(null);
  
  // Device assignment states
  const [availableDevices, setAvailableDevices] = useState<InventoryItem[]>([]);
  const [selectedDevice, setSelectedDevice] = useState<InventoryItem | null>(null);
  const [showDeviceSelector, setShowDeviceSelector] = useState(false);
  const [deviceSearchTerm, setDeviceSearchTerm] = useState('');
  
  // SGK states
  const [sgkSchemes, setSgkSchemes] = useState<SGKScheme[]>([]);
  const [selectedSgkScheme, setSelectedSgkScheme] = useState<SGKScheme | null>(null);
  const [sgkApprovalNumber, setSgkApprovalNumber] = useState('');
  const [sgkApprovalDate, setSgkApprovalDate] = useState('');
  
  // Service states
  const [serviceInfo, setServiceInfo] = useState<ServiceInfo>({
    type: 'warranty',
    description: '',
    duration: 24,
    cost: 0,
    notes: ''
  });

  // Payment tracking modal state
  const [showPaymentModal, setShowPaymentModal] = useState(false);

  const [formData, setFormData] = useState({
    productName: '',
    brand: '',
    model: '',
    serialNumber: '',
    listPrice: 0,
    salePrice: 0,
    discountAmount: 0,
    sgkCoverage: 0,
    notes: '',
    saleDate: '',
    // New fields
    deviceId: '',
    ear: 'both' as 'left' | 'right' | 'both',
    warrantyPeriod: 24,
    fittingDate: '',
    deliveryDate: ''
  });

  // Payment records state
  // Remove payment-related states and functions - moved to PaymentSummary
  // const [paymentRecords, setPaymentRecords] = useState<PaymentRecord[]>([]);
  // const [loadingPayments, setLoadingPayments] = useState(false);
  // const [showPaymentModal, setShowPaymentModal] = useState(false);

  // Calculate totals with actual payment data
  const [paymentRecords, setPaymentRecords] = useState<PaymentRecord[]>([]);
  const totalPaid = paymentRecords.reduce((sum, payment) => sum + (payment.amount || 0), 0);
  const remainingBalance = formData.salePrice - totalPaid;
  const discountPercentage = formData.listPrice > 0 ? ((formData.discountAmount / formData.listPrice) * 100) : 0;
  const hasPayments = paymentRecords.length > 0;

  // Load available devices for assignment
  const loadAvailableDevices = async () => {
    try {
      const api = getXEarCRMAPIAutoGenerated();
      const response = await api.inventoryGetInventoryItems({
        page: 1,
        per_page: 50,
        status: 'IN_STOCK',
        search: deviceSearchTerm
      });
      setAvailableDevices(response.data?.data || []);
    } catch (err) {
      console.error('Error loading devices:', err);
    }
  };

  // Load SGK schemes
  const loadSgkSchemes = async () => {
    // Mock SGK schemes - in real app, this would come from API
    const mockSchemes: SGKScheme[] = [
      { id: '1', name: 'SGK Genel', code: 'SGK001', coveragePercentage: 80, maxAmount: 5000 },
      { id: '2', name: 'SGK Emekli', code: 'SGK002', coveragePercentage: 90, maxAmount: 7500 },
      { id: '3', name: 'BaÄŸ-Kur', code: 'BK001', coveragePercentage: 75, maxAmount: 4500 },
      { id: '4', name: 'YeÅŸil Kart', code: 'YK001', coveragePercentage: 100, maxAmount: 3000 }
    ];
    setSgkSchemes(mockSchemes);
  };

  // Load payment records for this sale
  const loadPaymentRecords = async () => {
    try {
      // TODO: Replace with actual payments API when available
      // For now, use mock data or get from sale data
      setPaymentRecords([]);
    } catch (err) {
      console.error('Error loading payment records:', err);
      setPaymentRecords([]);
    }
  };

  // Load product details if productId exists
  const loadProductDetails = async () => {
    if (!sale.productId) return;
    
    try {
      const api = getXEarCRMAPIAutoGenerated();
      const response = await api.inventoryGetInventoryItem(sale.productId);
      setProductDetails(response.data?.data || null);
    } catch (err) {
      console.error('Error loading product details:', err);
    }
  };

  useEffect(() => {
    if (sale && isOpen) {
      loadProductDetails();
      loadAvailableDevices();
      loadSgkSchemes();
      loadPaymentRecords();
      
      // Initialize form with sale data
      setFormData({
        productName: productDetails?.name || sale.productId || '',
        brand: productDetails?.brand || '',
        model: productDetails?.model || '',
        serialNumber: productDetails?.availableSerials?.[0] || '',
        listPrice: sale.listPriceTotal || 0,
        salePrice: sale.totalAmount,
        discountAmount: sale.discountAmount || 0,
        sgkCoverage: sale.sgkCoverage || 0,
        notes: sale.notes || '',
        saleDate: sale.saleDate ? sale.saleDate.split('T')[0] : '',
        deviceId: sale.productId || '',
        ear: 'both',
        warrantyPeriod: 24,
        fittingDate: '',
        deliveryDate: ''
      });

      setSaleStatus(sale.status || 'draft');
      setPaymentMethod(sale.paymentMethod || 'cash');
      
      // Determine sale type based on product category
      if (productDetails?.category) {
        if (productDetails.category.toLowerCase().includes('cihaz') || 
            productDetails.category.toLowerCase().includes('device')) {
          setSaleType('device');
        } else if (productDetails.category.toLowerCase().includes('aksesuar') || 
                   productDetails.category.toLowerCase().includes('accessory')) {
          setSaleType('accessory');
        } else {
          setSaleType('service');
        }
      }
      
      setHasChanges(false);
    }
  }, [sale, isOpen, productDetails]);

  // Load devices when search term changes
  useEffect(() => {
    if (showDeviceSelector) {
      const debounceTimer = setTimeout(() => {
        loadAvailableDevices();
      }, 300);
      return () => clearTimeout(debounceTimer);
    }
  }, [deviceSearchTerm, showDeviceSelector]);

  if (!isOpen) return null;

  const handleInputChange = (field: string, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    setHasChanges(true);
  };

  const handleDeviceSelect = (device: InventoryItem) => {
    setSelectedDevice(device);
    setFormData(prev => ({
      ...prev,
      deviceId: device.id || '',
      productName: device.name,
      brand: device.brand,
      model: device.model || '',
      listPrice: device.price,
      salePrice: device.price
    }));
    setShowDeviceSelector(false);
    setHasChanges(true);
  };

  const handleSgkSchemeSelect = (scheme: SGKScheme) => {
    setSelectedSgkScheme(scheme);
    const coverage = Math.min(formData.listPrice * (scheme.coveragePercentage / 100), scheme.maxAmount || Infinity);
    setFormData(prev => ({
      ...prev,
      sgkCoverage: coverage
    }));
    setHasChanges(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!sale) return;
    
    setError(null);
    setSuccess(null);
    
    // Validation
    if (!formData.productName.trim()) {
      setError('ÃœrÃ¼n adÄ± gereklidir');
      return;
    }
    
    if (!formData.listPrice || formData.listPrice <= 0) {
      setError('GeÃ§erli bir liste fiyatÄ± giriniz');
      return;
    }
    
    if (formData.discountAmount < 0 || formData.discountAmount > formData.listPrice) {
      setError('Ä°ndirim tutarÄ± 0 ile liste fiyatÄ± arasÄ±nda olmalÄ±dÄ±r');
      return;
    }
    
    if (!formData.salePrice || formData.salePrice <= 0) {
      setError('GeÃ§erli bir satÄ±ÅŸ fiyatÄ± giriniz');
      return;
    }
    
    if (paymentMethod === 'installment' && installmentCount < 2) {
      setError('Taksit sayÄ±sÄ± en az 2 olmalÄ±dÄ±r');
      return;
    }

    if (saleType === 'device' && !formData.deviceId) {
      setError('LÃ¼tfen bir cihaz seÃ§iniz');
      return;
    }
    
    setIsLoading(true);
    
    try {
      // Prepare update data according to API schema
      const updateData: SalesUpdateSaleBody = {
        productId: formData.deviceId || sale.productId,
        saleDate: formData.saleDate,
        totalAmount: formData.salePrice,
        listPriceTotal: formData.listPrice,
        discountAmount: formData.discountAmount,
        sgkCoverage: formData.sgkCoverage,
        patientPayment: formData.salePrice - formData.sgkCoverage,
        paymentMethod: paymentMethod,
        status: saleStatus,
        notes: formData.notes.trim()
      };

      // Update sale using generated API client
      const api = getXEarCRMAPIAutoGenerated();
      const response = await api.salesUpdateSale(sale.id || '', updateData);
      const updatedSale = response.data;

      setSuccess('SatÄ±ÅŸ baÅŸarÄ±yla gÃ¼ncellendi');
      
      // Close modal after successful update
      setTimeout(() => {
        setError(null);
        setSuccess(null);
        onSaleUpdate(updatedSale);
        onClose();
      }, 2000);
      
    } catch (err) {
      console.error('Sale update failed:', err);
      setError('SatÄ±ÅŸ gÃ¼ncellenirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyiniz.');
    } finally {
      setIsLoading(false);
    }
  };

  const handlePriceCalculation = (field: 'listPrice' | 'discountAmount' | 'salePrice', value: number) => {
    const newFormData = { ...formData, [field]: value };
    
    if (field === 'listPrice' || field === 'discountAmount') {
      // Auto-calculate sale price when list price or discount changes
      newFormData.salePrice = newFormData.listPrice - newFormData.discountAmount;
    } else if (field === 'salePrice') {
      // Auto-calculate discount when sale price changes
      newFormData.discountAmount = newFormData.listPrice - newFormData.salePrice;
    }
    
    // Ensure values don't go negative
    newFormData.discountAmount = Math.max(0, newFormData.discountAmount);
    newFormData.salePrice = Math.max(0, newFormData.salePrice);
    
    // Recalculate SGK coverage if scheme is selected
    if (selectedSgkScheme) {
      const coverage = Math.min(newFormData.listPrice * (selectedSgkScheme.coveragePercentage / 100), selectedSgkScheme.maxAmount || Infinity);
      newFormData.sgkCoverage = coverage;
    }
    
    setFormData(newFormData);
    setHasChanges(true);
  };

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY'
    }).format(amount);
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('tr-TR');
  };

  const canEditFinancials = saleStatus !== 'paid' && totalPaid === 0;

  const filteredDevices = availableDevices.filter(device =>
    device.name.toLowerCase().includes(deviceSearchTerm.toLowerCase()) ||
    device.brand.toLowerCase().includes(deviceSearchTerm.toLowerCase()) ||
    (device.model && device.model.toLowerCase().includes(deviceSearchTerm.toLowerCase()))
  );

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-lg font-medium text-gray-900 flex items-center">
            <Edit className="w-5 h-5 mr-2" />
            SatÄ±ÅŸ DÃ¼zenle
          </h3>
          <Button
            onClick={onClose}
            className="p-1 text-gray-400 hover:text-gray-600"
          >
            <X className="w-5 h-5" />
          </Button>
        </div>

        {/* Error and Success Messages */}
        {error && (
          <Alert className="mb-4 bg-red-50 border-red-200 text-red-800">
            <AlertCircle className="w-4 h-4" />
            <span>{error}</span>
          </Alert>
        )}

        {success && (
          <Alert className="mb-4 bg-green-50 border-green-200 text-green-800">
            <CheckCircle className="w-4 h-4" />
            <span>{success}</span>
          </Alert>
        )}

        <form onSubmit={handleSubmit}>
          <div className="space-y-6">
            {/* Customer & Sale Info */}
            <div className="grid grid-cols-2 gap-6">
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-2">MÃ¼ÅŸteri Bilgileri</h4>
                <div className="space-y-1 text-sm">
                  <div><span className="font-medium">Ad Soyad:</span> {patient.firstName} {patient.lastName}</div>
                  <div><span className="font-medium">TC No:</span> {patient.tcNumber}</div>
                  <div><span className="font-medium">Telefon:</span> {patient.phone}</div>
                </div>
              </div>

              <div className="bg-blue-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-2">SatÄ±ÅŸ Durumu</h4>
                <div className="space-y-2">
                  <div className="text-sm">
                    <span className="font-medium">SatÄ±ÅŸ ID:</span> {sale.id}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                    <select
                      value={saleStatus}
                      onChange={(e) => {
                        setSaleStatus(e.target.value);
                        setHasChanges(true);
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="draft">Taslak</option>
                      <option value="confirmed">OnaylandÄ±</option>
                      <option value="paid">Ã–denmiÅŸ</option>
                      <option value="cancelled">Ä°ptal EdilmiÅŸ</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            {/* Payment Summary */}
            {hasPayments && (
              <div className="bg-green-50 p-4 rounded-lg">
                <h4 className="font-medium text-gray-900 mb-2">Ã–deme Ã–zeti</h4>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <span className="font-medium">Toplam Tutar:</span> {formatCurrency(sale.totalAmount)}
                  </div>
                  <div>
                    <span className="font-medium">Ã–denen:</span> {formatCurrency(totalPaid)}
                  </div>
                  <div className={remainingBalance > 0 ? 'text-red-700 font-medium' : 'text-green-700 font-medium'}>
                    <span className="font-medium">Kalan:</span> {formatCurrency(remainingBalance)}
                  </div>
                </div>
              </div>
            )}

            {/* Financial Edit Warning */}
            {!canEditFinancials && (
              <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                <div className="flex items-center text-yellow-800">
                  <AlertCircle className="w-5 h-5 mr-2" />
                  <span className="text-sm">
                    Bu satÄ±ÅŸa ait Ã¶demeler bulunduÄŸu iÃ§in fiyat bilgileri dÃ¼zenlenemez. 
                    Fiyat deÄŸiÅŸikliÄŸi iÃ§in Ã¶nce Ã¶demeleri iptal etmeniz gerekir.
                  </span>
                </div>
              </div>
            )}

            {/* Sale Date */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">SatÄ±ÅŸ Tarihi</label>
              <Input
                type="date"
                value={formData.saleDate}
                onChange={(e) => handleInputChange('saleDate', e.target.value)}
                className="w-48"
              />
            </div>

            {/* Sale Type */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">SatÄ±ÅŸ TÃ¼rÃ¼</label>
              <div className="grid grid-cols-3 gap-4">
                {[
                  { value: 'device', label: 'Cihaz', icon: 'ðŸ¦»' },
                  { value: 'service', label: 'Hizmet', icon: 'ðŸ”§' },
                  { value: 'accessory', label: 'Aksesuar', icon: 'ðŸ”‹' }
                ].map((type) => (
                  <button
                    key={type.value}
                    type="button"
                    onClick={() => {
                      setSaleType(type.value as any);
                      setHasChanges(true);
                    }}
                    className={`p-3 border rounded-lg text-center transition-colors ${
                      saleType === type.value
                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    <div className="text-2xl mb-1">{type.icon}</div>
                    <div className="text-sm font-medium">{type.label}</div>
                  </button>
                ))}
              </div>
            </div>

            {/* Device Assignment - Only for device sales */}
            {saleType === 'device' && (
              <div className="space-y-4">
                <h4 className="font-medium text-gray-900 flex items-center">
                  <Package className="w-4 h-4 mr-2" />
                  Cihaz SeÃ§imi
                </h4>
                
                <div className="border rounded-lg p-4">
                  {selectedDevice ? (
                    <div className="flex items-center justify-between bg-green-50 p-3 rounded-lg">
                      <div>
                        <div className="font-medium">{selectedDevice.name}</div>
                        <div className="text-sm text-gray-600">
                          {selectedDevice.brand} - {selectedDevice.model} | {formatCurrency(selectedDevice.price)}
                        </div>
                        {selectedDevice.availableSerials && selectedDevice.availableSerials.length > 0 && (
                          <div className="text-xs text-gray-500">
                            Seri No: {selectedDevice.availableSerials[0]}
                          </div>
                        )}
                      </div>
                      <Button
                        type="button"
                        onClick={() => setShowDeviceSelector(true)}
                        className="text-blue-600 hover:text-blue-800"
                      >
                        DeÄŸiÅŸtir
                      </Button>
                    </div>
                  ) : (
                    <Button
                      type="button"
                      onClick={() => setShowDeviceSelector(true)}
                      className="w-full py-3 border-2 border-dashed border-gray-300 hover:border-gray-400 text-gray-600"
                    >
                      <Search className="w-4 h-4 mr-2" />
                      Cihaz SeÃ§
                    </Button>
                  )}
                </div>

                {/* Device Selector Modal */}
                {showDeviceSelector && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60">
                    <div className="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                      <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-medium">Cihaz SeÃ§</h4>
                        <Button onClick={() => setShowDeviceSelector(false)}>
                          <X className="w-4 h-4" />
                        </Button>
                      </div>
                      
                      <div className="mb-4">
                        <Input
                          placeholder="Cihaz ara..."
                          value={deviceSearchTerm}
                          onChange={(e) => setDeviceSearchTerm(e.target.value)}
                          className="w-full"
                        />
                      </div>
                      
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {filteredDevices.map((device) => (
                          <div
                            key={device.id}
                            onClick={() => handleDeviceSelect(device)}
                            className="p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                          >
                            <div className="font-medium">{device.name}</div>
                            <div className="text-sm text-gray-600">
                              {device.brand} - {device.model} | {formatCurrency(device.price)}
                            </div>
                            <div className="text-xs text-gray-500">
                              Stok: {device.availableInventory} | Kategori: {device.category}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Device Details */}
                {selectedDevice && (
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Kulak</label>
                      <select
                        value={formData.ear}
                        onChange={(e) => handleInputChange('ear', e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="left">Sol</option>
                        <option value="right">SaÄŸ</option>
                        <option value="both">Her Ä°ki Kulak</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Garanti SÃ¼resi (Ay)</label>
                      <Input
                        type="number"
                        value={formData.warrantyPeriod}
                        onChange={(e) => handleInputChange('warrantyPeriod', parseInt(e.target.value) || 24)}
                        min="0"
                        max="60"
                      />
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Service Information - Only for service sales */}
            {saleType === 'service' && (
              <div className="space-y-4">
                <h4 className="font-medium text-gray-900 flex items-center">
                  <Wrench className="w-4 h-4 mr-2" />
                  Hizmet Bilgileri
                </h4>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Hizmet TÃ¼rÃ¼</label>
                    <select
                      value={serviceInfo.type}
                      onChange={(e) => setServiceInfo(prev => ({ ...prev, type: e.target.value as ServiceInfo['type'] }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="warranty">Garanti Hizmeti</option>
                      <option value="maintenance">BakÄ±m</option>
                      <option value="repair">OnarÄ±m</option>
                      <option value="calibration">Kalibrasyon</option>
                      <option value="fitting">Uyum</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">SÃ¼re (Ay)</label>
                    <Input
                      type="number"
                      value={serviceInfo.duration || ''}
                      onChange={(e) => setServiceInfo(prev => ({ ...prev, duration: parseInt(e.target.value) || 0 }))}
                      placeholder="Hizmet sÃ¼resi"
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Hizmet AÃ§Ä±klamasÄ±</label>
                  <Textarea
                    value={serviceInfo.description}
                    onChange={(e) => setServiceInfo(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="Hizmet detaylarÄ±..."
                    rows={3}
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Hizmet NotlarÄ±</label>
                  <Textarea
                    value={serviceInfo.notes || ''}
                    onChange={(e) => setServiceInfo(prev => ({ ...prev, notes: e.target.value }))}
                    placeholder="Ek notlar..."
                    rows={2}
                  />
                </div>
              </div>
            )}

            {/* Warranty Information - For device sales */}
            {saleType === 'device' && (
              <div className="space-y-4">
                <h4 className="font-medium text-gray-900 flex items-center">
                  <Settings className="w-4 h-4 mr-2" />
                  Garanti ve Hizmet
                </h4>
                
                <div className="grid grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Garanti SÃ¼resi (Ay)</label>
                    <Input
                      type="number"
                      value={formData.warrantyPeriod}
                      onChange={(e) => handleInputChange('warrantyPeriod', parseInt(e.target.value) || 24)}
                      placeholder="24"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Kulak</label>
                    <select
                      value={formData.ear}
                      onChange={(e) => handleInputChange('ear', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="left">Sol Kulak</option>
                      <option value="right">SaÄŸ Kulak</option>
                      <option value="both">Her Ä°ki Kulak</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Garanti BitiÅŸ</label>
                    <Input
                      type="text"
                      value={formData.saleDate ? 
                        new Date(new Date(formData.saleDate).getTime() + (formData.warrantyPeriod * 30 * 24 * 60 * 60 * 1000))
                          .toLocaleDateString('tr-TR') : 'SatÄ±ÅŸ tarihi giriniz'
                      }
                      disabled
                      className="bg-gray-50"
                    />
                  </div>
                </div>
              </div>
            )}

            {/* SGK Information */}
            <div className="space-y-4">
              <h4 className="font-medium text-gray-900 flex items-center">
                <FileText className="w-4 h-4 mr-2" />
                SGK Bilgileri
              </h4>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">SGK ÅžemasÄ±</label>
                  <select
                    value={selectedSgkScheme?.id || ''}
                    onChange={(e) => {
                      const scheme = sgkSchemes.find(s => s.id === e.target.value);
                      if (scheme) handleSgkSchemeSelect(scheme);
                    }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">SGK ÅžemasÄ± SeÃ§iniz</option>
                    {sgkSchemes.map((scheme) => (
                      <option key={scheme.id} value={scheme.id}>
                        {scheme.name} ({scheme.coveragePercentage}% - Max: {formatCurrency(scheme.maxAmount || 0)})
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">SGK Onay NumarasÄ±</label>
                  <Input
                    value={sgkApprovalNumber}
                    onChange={(e) => setSgkApprovalNumber(e.target.value)}
                    placeholder="SGK onay numarasÄ±"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">SGK Onay Tarihi</label>
                  <Input
                    type="date"
                    value={sgkApprovalDate}
                    onChange={(e) => setSgkApprovalDate(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">SGK KarÅŸÄ±lÄ±ÄŸÄ±</label>
                  <Input
                    type="number"
                    step="0.01"
                    value={formData.sgkCoverage}
                    onChange={(e) => handleInputChange('sgkCoverage', parseFloat(e.target.value) || 0)}
                    className="text-right"
                    disabled={!canEditFinancials}
                  />
                </div>
              </div>
              
              {selectedSgkScheme && (
                <div className="bg-blue-50 p-3 rounded-lg text-sm">
                  <div className="font-medium text-blue-900">{selectedSgkScheme.name}</div>
                  <div className="text-blue-700">
                    Kapsam: %{selectedSgkScheme.coveragePercentage} | 
                    Maksimum: {formatCurrency(selectedSgkScheme.maxAmount || 0)}
                  </div>
                  {selectedSgkScheme.description && (
                    <div className="text-blue-600 mt-1">{selectedSgkScheme.description}</div>
                  )}
                </div>
              )}
            </div>

            {/* Product Details */}
            <div className="space-y-4">
              <h4 className="font-medium text-gray-900 flex items-center">
                <CreditCard className="w-4 h-4 mr-2" />
                ÃœrÃ¼n Bilgileri
              </h4>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ÃœrÃ¼n AdÄ±</label>
                  <Input 
                    value={formData.productName}
                    onChange={(e) => handleInputChange('productName', e.target.value)}
                    placeholder="ÃœrÃ¼n adÄ±nÄ± giriniz" 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Marka</label>
                  <Input 
                    value={formData.brand}
                    onChange={(e) => handleInputChange('brand', e.target.value)}
                    placeholder="Marka" 
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                  <Input 
                    value={formData.model}
                    onChange={(e) => handleInputChange('model', e.target.value)}
                    placeholder="Model" 
                  />
                </div>
                {saleType === 'device' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Seri No</label>
                    <Input 
                      value={formData.serialNumber}
                      onChange={(e) => handleInputChange('serialNumber', e.target.value)}
                      placeholder="Seri numarasÄ±" 
                    />
                  </div>
                )}
              </div>
            </div>

            {/* Additional Dates - Only for device sales */}
            {saleType === 'device' && (
              <div className="space-y-4">
                <h4 className="font-medium text-gray-900">Ã–nemli Tarihler</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Uyum Tarihi</label>
                    <Input
                      type="date"
                      value={formData.fittingDate}
                      onChange={(e) => handleInputChange('fittingDate', e.target.value)}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Teslim Tarihi</label>
                    <Input
                      type="date"
                      value={formData.deliveryDate}
                      onChange={(e) => handleInputChange('deliveryDate', e.target.value)}
                    />
                  </div>
                </div>
              </div>
            )}

            {/* Pricing */}
            <div className="space-y-4">
              <h4 className="font-medium text-gray-900 flex items-center">
                <DollarSign className="w-4 h-4 mr-2" />
                FiyatlandÄ±rma
              </h4>
              
              <div className="grid grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Liste FiyatÄ±</label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.listPrice}
                    onChange={(e) => handlePriceCalculation('listPrice', parseFloat(e.target.value) || 0)}
                    className="text-right"
                    disabled={!canEditFinancials}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Ä°ndirim ({discountPercentage.toFixed(1)}%)
                  </label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.discountAmount}
                    onChange={(e) => handlePriceCalculation('discountAmount', parseFloat(e.target.value) || 0)}
                    className="text-right"
                    disabled={!canEditFinancials}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">SGK KarÅŸÄ±lÄ±ÄŸÄ±</label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.sgkCoverage}
                    onChange={(e) => handleInputChange('sgkCoverage', parseFloat(e.target.value) || 0)}
                    className="text-right"
                    disabled={!canEditFinancials}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">SatÄ±ÅŸ FiyatÄ± *</label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.salePrice}
                    onChange={(e) => handlePriceCalculation('salePrice', parseFloat(e.target.value) || 0)}
                    className="text-right font-medium"
                    disabled={!canEditFinancials}
                  />
                </div>
              </div>

              {!canEditFinancials && (
                <div className="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                  <strong>Mevcut Fiyat:</strong> {formatCurrency(sale.totalAmount)}
                </div>
              )}
            </div>

            {/* Payment Method */}
            <div className="space-y-4">
              <h4 className="font-medium text-gray-900 flex items-center">
                <CreditCard className="w-4 h-4 mr-2" />
                Ã–deme YÃ¶ntemi
              </h4>
              
              <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                {[
                  { value: 'cash', label: 'Nakit' },
                  { value: 'card', label: 'Kredi KartÄ±' },
                  { value: 'installment', label: 'Taksit' },
                  { value: 'bank_transfer', label: 'Havale' },
                  { value: 'sgk', label: 'SGK' }
                ].map((method) => (
                  <button
                    key={method.value}
                    type="button"
                    onClick={() => {
                      setPaymentMethod(method.value);
                      setHasChanges(true);
                    }}
                    className={`p-2 text-sm border rounded-md transition-colors ${
                      paymentMethod === method.value
                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    {method.label}
                  </button>
                ))}
              </div>

              {paymentMethod === 'installment' && (
                <div className="mt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Taksit SayÄ±sÄ±</label>
                  <select
                    value={installmentCount}
                    onChange={(e) => {
                      setInstallmentCount(parseInt(e.target.value));
                      setHasChanges(true);
                    }}
                    className="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    {[2, 3, 4, 6, 9, 12, 18, 24].map(count => (
                      <option key={count} value={count}>{count} Taksit</option>
                    ))}
                  </select>
                  <div className="text-sm text-gray-600 mt-1">
                    AylÄ±k Ã–deme: {formatCurrency(formData.salePrice / installmentCount)}
                  </div>
                </div>
              )}
            </div>

            {/* Notes */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Notlar</label>
              <Textarea
                value={formData.notes}
                onChange={(e) => handleInputChange('notes', e.target.value)}
                placeholder="SatÄ±ÅŸ ile ilgili notlar..."
                rows={3}
              />
            </div>
          </div>

          <div className="flex justify-between items-center space-x-3 mt-6 pt-6 border-t">
            <div className="flex space-x-2">
              <Button
                type="button"
                onClick={() => setShowPaymentModal(true)}
                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md flex items-center"
              >
                <CreditCard className="w-4 h-4 mr-2" />
                Ã–deme Takibi
              </Button>
            </div>
            
            <div className="flex space-x-3">
              <Button
                type="button"
                onClick={onClose}
                className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md"
              >
                Ä°ptal
              </Button>
              <Button
                type="submit"
                className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md flex items-center"
                disabled={loading || isLoading || !hasChanges || !!error}
              >
                {(loading || isLoading) && <Loading className="w-4 h-4 mr-2" />}
                {(loading || isLoading) ? 'Kaydediliyor...' : 'DeÄŸiÅŸiklikleri Kaydet'}
              </Button>
            </div>
          </div>
        </form>
      </div>
      
      {/* Payment Tracking Modal */}
      <PaymentTrackingModal
        isOpen={showPaymentModal}
        onClose={() => setShowPaymentModal(false)}
        sale={sale}
        onPaymentUpdate={() => {
          // Refresh sale data or trigger parent update
          onSaleUpdate(sale);
        }}
      />
    </div>
  );
};

export default EditSaleModal;