import { useState, useEffect } from 'react';
import { inventoryGetInventoryItems, inventoryGetInventoryItem, salesUpdateSale } from '../../../../../api/generated/xEarCRMAPIAutoGenerated';
import type {
  InventoryItem,
  SalesUpdateSaleBody
} from '../../../../../api/generated/schemas';
import type {
  Sale,
  SaleFormData,
  EditSaleState,
  PaymentRecord,
  SGKScheme,
  ServiceInfo
} from '../types';

export const useEditSale = (sale: Sale, isOpen: boolean) => {
  // Form data state
  const [formData, setFormData] = useState<SaleFormData>({
    productName: '',
    brand: '',
    model: '',
    serialNumber: '',
    listPrice: 0,
    salePrice: 0,
    discountAmount: 0,
    sgkCoverage: 0,
    notes: '',
    saleDate: '',
    deviceId: '',
    ear: 'both',
    warrantyPeriod: 24,
    fittingDate: '',
    deliveryDate: ''
  });

  // UI state
  const [state, setState] = useState<EditSaleState>({
    saleType: 'device',
    saleStatus: 'draft',
    paymentMethod: 'cash',
    deviceSearchTerm: '',
    showPaymentModal: false,
    showSgkModal: false,
    showServiceModal: false,
    showDeviceSelector: false,
    isSubmitting: false,
    error: null,
    success: false
  });

  // Data states
  const [availableDevices, setAvailableDevices] = useState<InventoryItem[]>([]);
  const [productDetails, setProductDetails] = useState<InventoryItem | null>(null);
  const [sgkSchemes, setSgkSchemes] = useState<SGKScheme[]>([]);
  const [paymentRecords, setPaymentRecords] = useState<PaymentRecord[]>([]);
  const [serviceInfo, setServiceInfo] = useState<ServiceInfo>({
    type: 'warranty',
    description: '',
    duration: 24,
    cost: 0,
    notes: ''
  });

  // Calculated values
  const totalPaid = paymentRecords.reduce((sum, payment) => sum + (payment.amount || 0), 0);
  const remainingBalance = formData.salePrice - totalPaid;
  const discountPercentage = formData.listPrice > 0 ? ((formData.discountAmount / formData.listPrice) * 100) : 0;
  const hasPayments = paymentRecords.length > 0;

  // Load available devices for assignment
  const loadAvailableDevices = async () => {
    try {
      const response = await inventoryGetInventoryItems({
        page: 1,
        per_page: 50,
        status: 'IN_STOCK',
        search: state.deviceSearchTerm
      });
      setAvailableDevices(response.data?.data || []);
    } catch (err) {
      console.error('Error loading devices:', err);
    }
  };

  // Load SGK schemes
  const loadSgkSchemes = async () => {
    // Mock SGK schemes - in real app, this would come from API
    const mockSchemes: SGKScheme[] = [
      { id: '1', name: 'SGK Genel', code: 'SGK001', coveragePercentage: 80, maxAmount: 5000 },
      { id: '2', name: 'SGK Emekli', code: 'SGK002', coveragePercentage: 90, maxAmount: 7500 },
      { id: '3', name: 'Bağ-Kur', code: 'BK001', coveragePercentage: 75, maxAmount: 4500 },
      { id: '4', name: 'Yeşil Kart', code: 'YK001', coveragePercentage: 100, maxAmount: 3000 }
    ];
    setSgkSchemes(mockSchemes);
  };

  // Load payment records for this sale
  const loadPaymentRecords = async () => {
    try {
      // TODO: Replace with actual payments API when available
      // For now, use mock data or get from sale data
      setPaymentRecords([]);
    } catch (err) {
      console.error('Error loading payment records:', err);
      setPaymentRecords([]);
    }
  };

  // Load product details if productId exists
  const loadProductDetails = async () => {
    if (!sale.productId) return;

    try {
      const response = await inventoryGetInventoryItem(sale.productId);
      setProductDetails(response.data?.data || null);
    } catch (err) {
      console.error('Error loading product details:', err);
    }
  };

  // Initialize form data when sale changes
  useEffect(() => {
    if (sale && isOpen) {
      loadProductDetails();
      loadAvailableDevices();
      loadSgkSchemes();
      loadPaymentRecords();

      // Initialize form with sale data
      setFormData({
        productName: productDetails?.name || sale.productId || '',
        brand: productDetails?.brand || '',
        model: productDetails?.model || '',
        serialNumber: productDetails?.availableSerials?.[0] || '',
        listPrice: sale.listPriceTotal || 0,
        salePrice: sale.totalAmount,
        discountAmount: sale.discountAmount || 0,
        sgkCoverage: sale.sgkCoverage || 0,
        notes: sale.notes || '',
        saleDate: sale.saleDate ? sale.saleDate.split('T')[0] : '',
        deviceId: sale.productId || '',
        ear: 'both',
        warrantyPeriod: 24,
        fittingDate: '',
        deliveryDate: ''
      });

      setState(prev => ({
        ...prev,
        saleStatus: sale.status || 'PENDING',
        paymentMethod: sale.paymentMethod || 'cash',
        saleType: productDetails?.category === 'hearing_aid' ? 'device' : 'service'
      }));
    }
  }, [sale, isOpen, productDetails]);

  // Update form data
  const updateFormData = (updates: Partial<SaleFormData>) => {
    setFormData(prev => ({ ...prev, ...updates }));
  };

  // Update state
  const updateState = (updates: Partial<EditSaleState>) => {
    setState(prev => ({ ...prev, ...updates }));
  };

  // Validate form
  const validateForm = (): boolean => {
    if (!formData.productName.trim()) {
      updateState({ error: 'Product name is required' });
      return false;
    }
    if (formData.salePrice <= 0) {
      updateState({ error: 'Sale price must be greater than 0' });
      return false;
    }
    if (!formData.saleDate) {
      updateState({ error: 'Sale date is required' });
      return false;
    }
    return true;
  };

  // Submit form
  const submitForm = async (onSaleUpdate: (sale: Sale) => void) => {
    if (!validateForm()) return;

    updateState({ isSubmitting: true, error: null });

    try {
      const updateData: SalesUpdateSaleBody = {
        totalAmount: formData.salePrice,
        discountAmount: formData.discountAmount,
        sgkCoverage: formData.sgkCoverage,
        notes: formData.notes,
        status: state.saleStatus,
        paymentMethod: state.paymentMethod,
        saleDate: formData.saleDate
      };

      const response = await salesUpdateSale(sale.id!, updateData);

      if (response.data) {
        onSaleUpdate(response.data as Sale);
        updateState({ success: true, isSubmitting: false });

        setTimeout(() => {
          updateState({ success: false });
        }, 2000);
      }
    } catch (err: any) {
      console.error('Error updating sale:', err);
      updateState({
        error: err.response?.data?.error || 'Failed to update sale',
        isSubmitting: false
      });
    }
  };

  // Reset form
  const resetForm = () => {
    setFormData({
      productName: '',
      brand: '',
      model: '',
      serialNumber: '',
      listPrice: 0,
      salePrice: 0,
      discountAmount: 0,
      sgkCoverage: 0,
      notes: '',
      saleDate: '',
      deviceId: '',
      ear: 'both',
      warrantyPeriod: 24,
      fittingDate: '',
      deliveryDate: ''
    });

    setState({
      saleType: 'device',
      saleStatus: 'draft',
      paymentMethod: 'cash',
      deviceSearchTerm: '',
      showPaymentModal: false,
      showSgkModal: false,
      showServiceModal: false,
      showDeviceSelector: false,
      isSubmitting: false,
      error: null,
      success: false
    });
  };

  return {
    // State
    formData,
    state,
    availableDevices,
    productDetails,
    sgkSchemes,
    paymentRecords,
    serviceInfo,

    // Calculated values
    totalPaid,
    remainingBalance,
    discountPercentage,
    hasPayments,

    // Actions
    updateFormData,
    updateState,
    validateForm,
    submitForm,
    resetForm,
    loadAvailableDevices,
    setServiceInfo
  };
};