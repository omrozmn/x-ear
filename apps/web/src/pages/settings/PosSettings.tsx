
import React, { useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { Button, Input, Checkbox, useToastHelpers } from '@x-ear/ui-web';
import { useGetPaytrConfig, useUpdatePaytrConfig } from '../../api/generated/xEarCRMAPIAutoGenerated';

interface PosConfigForm {
    merchant_id: string;
    merchant_key: string;
    merchant_salt: string;
    test_mode: boolean;
}

export const PosSettings = () => {
    const { register, handleSubmit, reset, setValue, watch } = useForm<PosConfigForm>();
    const { success, error } = useToastHelpers();

    // Hooks
    const { data: configData, isLoading } = useGetPaytrConfig();
    const { mutate: updateConfig, isPending } = useUpdatePaytrConfig();

    useEffect(() => {
        if (configData?.data?.data) {
            const d = configData.data.data;
            reset({
                merchant_id: d.merchant_id,
                merchant_key: d.merchant_key,
                merchant_salt: d.merchant_salt,
                test_mode: d.test_mode
            });
        }
    }, [configData, reset]);

    const onSubmit = (data: PosConfigForm) => {
        updateConfig({
            data: data
        }, {
            onSuccess: () => {
                success('POS ayarları güncellendi');
            },
            onError: (err: any) => {
                error(err.response?.data?.error || 'Güncelleme başarısız');
            }
        });
    };

    if (isLoading) return <div>Yükleniyor...</div>;

    return (
        <div className="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
            <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">PayTR Entegrasyonu</h3>
            <p className="text-gray-500 mb-6 font-sm">
                PayTR mağaza panelinden alacağınız bilgileri aşağıya giriniz.
                Test modu açıkken gerçek ödeme alınmaz.
            </p>

            <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 max-w-lg">
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Mağaza No (Merchant ID)
                    </label>
                    <Input {...register('merchant_id')} placeholder="Örn: 123456" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Mağaza Parola (Merchant Key)
                    </label>
                    <Input {...register('merchant_key')} type="password" placeholder="Mağaza Anahtarı" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Mağaza Gizli Anahtar (Merchant Salt)
                    </label>
                    <Input {...register('merchant_salt')} type="password" placeholder="Mağaza Gizli Anahtarı" />
                </div>

                <div className="flex items-center space-x-2 pt-2">
                    <Checkbox
                        id="test_mode"
                        checked={watch('test_mode') || false}
                        onChange={(e) => setValue('test_mode', (e.target as any).checked)}
                    />
                    <label htmlFor="test_mode" className="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">
                        Test Modu Aktif
                    </label>
                </div>

                <div className="pt-4">
                    <Button type="submit" disabled={isPending}>
                        {isPending ? 'Kaydediliyor...' : 'Ayarları Kaydet'}
                    </Button>
                </div>
            </form>
        </div>
    );
};
