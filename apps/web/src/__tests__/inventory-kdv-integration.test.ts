import axios from 'axios';
import { getXEarCRMAPIAutoGenerated } from '../api/generated/xEarCRMAPIAutoGenerated';

const BACKEND = process.env.TEST_BACKEND_URL || process.env.BACKEND_URL || 'http://127.0.0.1:5003';

describe('Inventory KDV integration', () => {
  it('should persist kdv changes via API', async () => {
    // Skip if backend is not reachable
    try {
      await axios.get(`${BACKEND}/api/health`);
    } catch (err) {
      console.warn('Skipping integration test: backend not reachable');
      return;
    }

    // Create item
    const createResp = await axios.post(`${BACKEND}/api/inventory`, {
      name: 'Vitest Integration KDV',
      brand: 'TestBrand',
      category: 'accessory',
      price: 123.45
    });
    expect(createResp.status).toBe(201);
    const item = createResp.data.data;
    const id = item.id;

    // Update KDV via our helper so frontend call is tested
    const api = getXEarCRMAPIAutoGenerated();
    const updateResp = await api.inventoryUpdateInventoryItem(id, { kdv: 1, priceIncludesKdv: true, costIncludesKdv: false }, { baseURL: BACKEND });
    expect(updateResp.status).toBe(200);
    expect(updateResp.data.success).toBe(true);
    expect(updateResp.data.data.kdv).toBe(1);
    // debug log
    console.log('UPDATE RESP:', JSON.stringify(updateResp.data));
    expect(updateResp.data.data.priceIncludesKdv).toBe(true);
    expect(updateResp.data.data.costIncludesKdv).toBe(false);

    // GET and verify
    const getResp = await axios.get(`${BACKEND}/api/inventory/${id}`);
    expect(getResp.status).toBe(200);
    expect(getResp.data.data.kdv).toBe(1);
    expect(getResp.data.data.priceIncludesKdv).toBe(true);
    expect(getResp.data.data.costIncludesKdv).toBe(false);

    // Cleanup
    await axios.delete(`${BACKEND}/api/inventory/${id}`);
  });
});
