import { useState } from 'react';
import { Container, Title, Button, Group, Badge, Pagination, Stack } from '@mantine/core';
import { SupplierList } from '@/components/suppliers/SupplierList';
import { SupplierFilters } from '@/components/suppliers/SupplierFilters';
import { SupplierFormModal } from '@/components/suppliers/SupplierFormModal';
import { useSuppliers } from '@/hooks/useSuppliers';
import type { Supplier } from '@/api/generated/xEarCRMAPIAutoGenerated.schemas.ts/supplier';
import type { SupplierSearchState } from '@/components/suppliers/supplier-search.types';
import type { SuppliersGetSuppliersStatus } from '@/api/generated/xEarCRMAPIAutoGenerated.schemas.ts/suppliersGetSuppliersStatus';
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/suppliers/')({
  component: SuppliersPage,
});

function SuppliersPage() {
  const [searchState, setSearchState] = useState<SupplierSearchState>({ page: 1 });
  const [modalOpened, setModalOpened] = useState(false);
  const [selectedSupplier, setSelectedSupplier] = useState<Supplier | undefined>(undefined);

  const { data, isLoading, error, refetch } = useSuppliers(searchState);

  const handleSearchChange = (search: string) => {
    setSearchState(prevState => ({ ...prevState, search, page: 1 }));
  };

  const handleStatusChange = (status: SuppliersGetSuppliersStatus | null) => {
    setSearchState(prevState => ({ ...prevState, status: status ?? undefined, page: 1 }));
  };

  const handleModalOpen = () => {
    setSelectedSupplier(undefined);
    setModalOpened(true);
  };

  const handleEdit = (supplier: Supplier) => {
    setSelectedSupplier(supplier);
    setModalOpened(true);
  };

  const handleModalClose = () => {
    setModalOpened(false);
    setSelectedSupplier(undefined);
    refetch();
  };

  const suppliers = data?.data?.data ?? [];
  const pagination = data?.data?.pagination;

  return (
    <Container fluid>
      <Group justify="space-between" mb="md">
        <Group>
          <Title order={2}>Tedarikçiler</Title>
          <Badge variant="light" color="blue">{pagination?.total ?? suppliers.length} kayıt</Badge>
        </Group>
        <Button onClick={handleModalOpen}>Yeni Tedarikçi</Button>
      </Group>

      <Stack gap="md">
        <SupplierFilters onSearchChange={handleSearchChange} onStatusChange={handleStatusChange} />

        <SupplierList suppliers={suppliers} isLoading={isLoading} error={error as any} onEdit={handleEdit} />

        {pagination?.totalPages && pagination.totalPages > 1 && (
          <Group justify="center">
            <Pagination total={pagination.totalPages} value={searchState.page ?? 1} onChange={(page) => setSearchState((s) => ({ ...s, page }))} />
          </Group>
        )}
      </Stack>

      <SupplierFormModal opened={modalOpened} onClose={handleModalClose} supplier={selectedSupplier} />
    </Container>
  );
}