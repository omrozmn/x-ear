{% extends 'base.html' %}

{% block content %}
  <!-- EMM Header Info -->
  <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
    <div style="font-weight: 700; color: #b45309; margin-bottom: 8px; font-size: 12px;">
      e-MÜSTAHSİL MAKBUZU
    </div>
    <table style="width: 100%; font-size: 10px; color: #78350f;">
      <tr>
        <td style="width: 50%; vertical-align: top;">
          {% if invoice.producer_name or invoice.mustahsil_adi %}
          <div><strong>Müstahsil Adı:</strong> {{ invoice.producer_name or invoice.mustahsil_adi }}</div>
          {% endif %}
          {% if invoice.producer_tc or invoice.mustahsil_tc %}
          <div><strong>Müstahsil TC:</strong> {{ invoice.producer_tc or invoice.mustahsil_tc }}</div>
          {% endif %}
          {% if invoice.producer_address or invoice.mustahsil_adres %}
          <div><strong>Müstahsil Adresi:</strong> {{ invoice.producer_address or invoice.mustahsil_adres }}</div>
          {% endif %}
        </td>
        <td style="width: 50%; vertical-align: top;">
          {% if invoice.product_type or invoice.urun_cinsi %}
          <div><strong>Ürün Cinsi:</strong> {{ invoice.product_type or invoice.urun_cinsi }}</div>
          {% endif %}
          {% if invoice.harvest_date or invoice.hasat_tarihi %}
          <div><strong>Hasat Tarihi:</strong> {{ invoice.harvest_date or invoice.hasat_tarihi }}</div>
          {% endif %}
        </td>
      </tr>
    </table>
  </div>

  <!-- Invoice Lines Table -->
  <table class="items">
    <thead>
      <tr>
        <th style="width: 5%">Sıra No</th>
        <th style="width: 40%">Ürün / Hizmet</th>
        <th style="width: 12%" class="right">Miktar</th>
        <th style="width: 8%">Birim</th>
        <th style="width: 15%" class="right">Birim Fiyat</th>
        <th style="width: 20%" class="right">Tutar</th>
      </tr>
    </thead>
    <tbody>
      {% for line in invoice.lines %}
      <tr>
        <td class="center">{{ loop.index }}</td>
        <td>{{ line.description or line.name }}</td>
        <td class="right">{{ line.quantity }}</td>
        <td>{{ line.unit_code or 'Kg' }}</td>
        <td class="right">{{ "%.2f"|format(line.unit_price|float) }} TL</td>
        <td class="right">{{ "%.2f"|format((line.line_extension_amount or (line.quantity|float * line.unit_price|float))|float) }} TL</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Totals -->
  <div class="totals-section">
    <table class="totals-table">
      <tr>
        <td>Mal Bedeli</td>
        <td>{{ "%.2f"|format((invoice.line_extension_amount or invoice.subtotal or 0)|float) }} TL</td>
      </tr>
      {% if invoice.stoppage_rate or invoice.stopaj_orani %}
      <tr>
        <td>Stopaj (%{{ invoice.stoppage_rate or invoice.stopaj_orani or 2 }})</td>
        <td>{{ "%.2f"|format((invoice.stoppage_amount or invoice.stopaj_tutari or 0)|float) }} TL</td>
      </tr>
      {% endif %}
      {% if invoice.bag_kur_rate or invoice.bagkur_orani %}
      <tr>
        <td>Bağ-Kur (%{{ invoice.bag_kur_rate or invoice.bagkur_orani or 1 }})</td>
        <td>{{ "%.2f"|format((invoice.bag_kur_amount or invoice.bagkur_tutari or 0)|float) }} TL</td>
      </tr>
      {% endif %}
      <tr class="grand-total">
        <td>Net Ödenecek Tutar</td>
        <td>{{ "%.2f"|format((invoice.payable_amount or 0)|float) }} TL</td>
      </tr>
    </table>
  </div>

  <!-- Notes -->
  {% if invoice.notes %}
  <div class="notes mt-2">
    <div class="notes-title">Notlar:</div>
    {{ invoice.notes }}
  </div>
  {% endif %}

  <!-- Payment Info -->
  {% if invoice.payment_method or invoice.odeme_yontemi %}
  <div class="notes mt-2" style="background: #ecfdf5; border-color: #10b981;">
    <div class="notes-title" style="color: #059669;">Ödeme Bilgileri:</div>
    <div>Ödeme Yöntemi: {{ invoice.payment_method or invoice.odeme_yontemi }}</div>
    {% if invoice.bank_name %}<div>Banka: {{ invoice.bank_name }}</div>{% endif %}
    {% if invoice.iban %}<div>IBAN: {{ invoice.iban }}</div>{% endif %}
  </div>
  {% endif %}
{% endblock %}
