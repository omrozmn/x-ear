import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Adjust paths relative to this script
// Script is in apps/web/scripts/check-orval.js
// openapi.yaml is in apps/openapi.yaml (based on orval config saying ../openapi.yaml from apps/web root?)
// Let's verify openapi.yaml location.
// orval.config.mjs in apps/web says input target: '../openapi.yaml'.
// So if we run from apps/web, it's ../openapi.yaml.
// If we are in apps/web/scripts, it is ../../openapi.yaml.

const specPath = path.resolve(__dirname, "../../openapi.yaml");
const clientPath = path.resolve(__dirname, "../src/api/generated/xEarCRMAPIAutoGenerated.ts");

console.log(`Checking Spec: ${specPath}`);
console.log(`Checking Client: ${clientPath}`);

if (!fs.existsSync(specPath)) {
    console.error(`❌ Spec file not found at ${specPath}`);
    process.exit(1);
}

if (!fs.existsSync(clientPath)) {
    console.error(`❌ Client file not found at ${clientPath}`);
    process.exit(1);
}

const spec = fs.readFileSync(specPath).toString();
const client = fs.readFileSync(clientPath).toString();

// Helper to convert snake_case to camelCase
const toCamelCase = (str) => {
    return str.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
};

// Spec içindeki all operationId'leri çek
// Regex to find operationId: value
const operationIds = [...spec.matchAll(/operationId:\s*(\w+)/g)].map(m => m[1]);

// Client içindeki export edilmiş fonksiyonları çek
// Regex to find export const functionName
const exports = [...client.matchAll(/export const (\w+)/g)].map(m => m[1]);

// Eksik olanları bul
// Compare camelCased operationId with exports
const missing = operationIds.filter(op => {
    const camelOp = toCamelCase(op);
    return !exports.includes(camelOp);
});

if (missing.length > 0) {
    console.error("❌ Eksik endpoint(ler) (camelCase conversion applied):", missing);
    console.log("Example missing operationId:", missing[0], "-> expected:", toCamelCase(missing[0]));
    process.exit(1);
} else {
    console.log("✅ Tüm endpointler Orval client içinde mevcut.");
    console.log(`Total Operations: ${operationIds.length}`);
    console.log(`Total Exports: ${exports.length}`);
}
