============================= test session starts ==============================
platform darwin -- Python 3.12.7, pytest-7.4.3, pluggy-1.0.0
rootdir: /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api
configfile: pytest.ini
plugins: asyncio-0.21.1, Faker-37.11.0, anyio-3.7.1, zarr-3.1.5
asyncio: mode=Mode.STRICT
collected 6 items

apps/api/tests/integration/test_response_standardization.py ....FF       [100%]

=================================== FAILURES ===================================
__________________ test_appointment_response_standardization ___________________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x3134328d0>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

mock_db_session = <MagicMock id='13208051136'>
mock_access_context = <MagicMock spec='UnifiedAccess' id='13208045136'>

    def test_appointment_response_standardization(mock_db_session, mock_access_context):
        """Verify Appointment endpoints return standardized camelCase response"""
        from models.appointment import Appointment
        from models.enums import AppointmentStatus
    
        appointment = Appointment(
            id="apt_123",
            tenant_id="tenant_123",
            party_id="party_123",
            clinician_id="user_123",
            date=datetime.now(),
            time="10:00",
            duration=30,
            appointment_type="consultation",
            status="scheduled", # Use string matching expected output
            notes="Test Appointment",
            created_at=datetime.utcnow(),
            updated_at=datetime.utcnow()
        )
    
        def side_effect_get(model, id):
            if model == Appointment and id == "apt_123":
                return appointment
            return None
    
        mock_db_session.get.side_effect = side_effect_get
    
        import middleware.unified_access
        with patch.object(middleware.unified_access, "_build_access_from_token", return_value=mock_access_context):
>           response = client.get("/api/appointments/apt_123", headers={"Authorization": "Bearer mocked"})

apps/api/tests/integration/test_response_standardization.py:257: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/opt/homebrew/anaconda3/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/opt/homebrew/anaconda3/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/middleware/tenant_context.py:84: in tenant_context_middleware
    response = await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/fastapi_app/middleware.py:23: in request_id_middleware
    response = await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/middleware/permission_middleware.py:103: in dispatch
    return await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/middleware/idempotency.py:23: in idempotency_middleware
    return await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    content = await serialize_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def serialize_response(
        *,
        field: Optional[ModelField] = None,
        response_content: Any,
        include: Optional[IncEx] = None,
        exclude: Optional[IncEx] = None,
        by_alias: bool = True,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        is_coroutine: bool = True,
    ) -> Any:
        if field:
            errors = []
            if not hasattr(field, "serialize"):
                # pydantic v1
                response_content = _prepare_response_content(
                    response_content,
                    exclude_unset=exclude_unset,
                    exclude_defaults=exclude_defaults,
                    exclude_none=exclude_none,
                )
            if is_coroutine:
                value, errors_ = field.validate(response_content, {}, loc=("response",))
            else:
                value, errors_ = await run_in_threadpool(
                    field.validate, response_content, {}, loc=("response",)
                )
            if isinstance(errors_, list):
                errors.extend(errors_)
            elif errors_:
                errors.append(errors_)
            if errors:
>               raise ResponseValidationError(
                    errors=_normalize_errors(errors), body=response_content
                )
E               fastapi.exceptions.ResponseValidationError: 1 validation errors:
E                 {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': "Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'", 'input': 'SCHEDULED', 'ctx': {'expected': "'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'"}}

/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py:155: ResponseValidationError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-16T13:08:54.575643+00:00", "level": "WARNING", "logger": "middleware.permission_middleware", "message": "JWT decode failed: Not enough segments"}
ERROR: Unhandled exception: 1 validation errors:
  {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': "Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'", 'input': 'SCHEDULED', 'ctx': {'expected': "'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'"}}

Traceback: Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/tenant_context.py", line 84, in tenant_context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/fastapi_app/middleware.py", line 23, in request_id_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/permission_middleware.py", line 103, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/idempotency.py", line 23, in idempotency_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 292, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 155, in serialize_response
    raise ResponseValidationError(
fastapi.exceptions.ResponseValidationError: 1 validation errors:
  {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': "Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'", 'input': 'SCHEDULED', 'ctx': {'expected': "'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'"}}


{"timestamp": "2026-01-16T13:08:54.580488+00:00", "level": "ERROR", "logger": "x-ear", "message": "Unhandled exception: 1 validation errors:\n  {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': \"Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'\", 'input': 'SCHEDULED', 'ctx': {'expected': \"'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'\"}}\n"}
{"timestamp": "2026-01-16T13:08:54.580541+00:00", "level": "ERROR", "logger": "x-ear", "message": "Traceback: Traceback (most recent call last):\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py\", line 98, in receive\n    return self.receive_nowait()\n           ^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py\", line 93, in receive_nowait\n    raise WouldBlock\nanyio.WouldBlock\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 78, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py\", line 118, in receive\n    raise EndOfStream\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 162, in __call__\n    await self.app(scope, receive, _send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/tenant_context.py\", line 84, in tenant_context_middleware\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/fastapi_app/middleware.py\", line 23, in request_id_middleware\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/permission_middleware.py\", line 103, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/idempotency.py\", line 23, in idempotency_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 79, in __call__\n    raise exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 68, in __call__\n    await self.app(scope, receive, sender)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py\", line 20, in __call__\n    raise e\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py\", line 17, in __call__\n    await self.app(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py\", line 718, in __call__\n    await route.handle(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py\", line 276, in handle\n    await self.app(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py\", line 66, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py\", line 292, in app\n    content = await serialize_response(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py\", line 155, in serialize_response\n    raise ResponseValidationError(\nfastapi.exceptions.ResponseValidationError: 1 validation errors:\n  {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': \"Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'\", 'input': 'SCHEDULED', 'ctx': {'expected': \"'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'\"}}\n\n"}
------------------------------ Captured log call -------------------------------
WARNING  middleware.permission_middleware:permission_middleware.py:68 JWT decode failed: Not enough segments
ERROR    x-ear:main.py:185 Unhandled exception: 1 validation errors:
  {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': "Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'", 'input': 'SCHEDULED', 'ctx': {'expected': "'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'"}}

ERROR    x-ear:main.py:186 Traceback: Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/tenant_context.py", line 84, in tenant_context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/fastapi_app/middleware.py", line 23, in request_id_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/permission_middleware.py", line 103, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/idempotency.py", line 23, in idempotency_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 292, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 155, in serialize_response
    raise ResponseValidationError(
fastapi.exceptions.ResponseValidationError: 1 validation errors:
  {'type': 'enum', 'loc': ('response', 'data', 'status'), 'msg': "Input should be 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'", 'input': 'SCHEDULED', 'ctx': {'expected': "'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show' or 'rescheduled'"}}
_____________________ test_device_response_standardization _____________________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x3131e93d0>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

mock_db_session = <MagicMock id='13208045328'>
mock_access_context = <MagicMock spec='UnifiedAccess' id='13207069296'>

    def test_device_response_standardization(mock_db_session, mock_access_context):
        """Verify Device endpoints return standardized camelCase response"""
        from core.models.device import Device
    
        device = Device(
            id="dev_123",
            tenant_id="tenant_123",
            party_id="inventory",
            inventory_id="inv_123",
            serial_number="SN123",
            brand="BrandX",
            model="ModelY",
            device_type="BTE",
            category="hearing_aid",
            ear="right",
            status="in_stock",
            price=1000.0,
            created_at=datetime.utcnow(),
            updated_at=datetime.utcnow()
        )
        # Set helper properties that might be computed or aliased
        device.kdv_rate = 18.0
        device.features = []
        device.branch_id = None
        device.barcode = None
        device.cost = 0.0
        # Simulate property access for trial_period/warranty if needed by schema logic
        # But schema uses alias="trialPeriod". Device doesn't have it. Defaults to None.
    
        def side_effect_get(model, id):
            if model == Device and id == "dev_123":
                return device
            return None
    
        mock_db_session.get.side_effect = side_effect_get
    
        import middleware.unified_access
        with patch.object(middleware.unified_access, "_build_access_from_token", return_value=mock_access_context):
>           response = client.get("/api/devices/dev_123", headers={"Authorization": "Bearer mocked"})

apps/api/tests/integration/test_response_standardization.py:307: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/opt/homebrew/anaconda3/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/opt/homebrew/anaconda3/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/middleware/tenant_context.py:84: in tenant_context_middleware
    response = await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/fastapi_app/middleware.py:23: in request_id_middleware
    response = await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/middleware/permission_middleware.py:103: in dispatch
    return await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
apps/api/middleware/idempotency.py:23: in idempotency_middleware
    return await call_next(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    content = await serialize_response(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py:180: in serialize_response
    return jsonable_encoder(response_content)
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/encoders.py:223: in jsonable_encoder
    obj_dict = _model_dump(
/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/_compat.py:177: in _model_dump
    return model.model_dump(mode=mode, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = ResponseEnvelope(success=True, data=<core.models.device.Device object at 0x31333f5c0>, message=None, error=None, meta=None, request_id=None, timestamp=datetime.datetime(2026, 1, 16, 13, 8, 54, 714023, tzinfo=datetime.timezone.utc))

    def model_dump(
        self,
        *,
        mode: Literal['json', 'python'] | str = 'python',
        include: IncEx = None,
        exclude: IncEx = None,
        by_alias: bool = False,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        round_trip: bool = False,
        warnings: bool = True,
    ) -> dict[str, Any]:
        """Usage docs: https://docs.pydantic.dev/2.5/concepts/serialization/#modelmodel_dump
    
        Generate a dictionary representation of the model, optionally specifying which fields to include or exclude.
    
        Args:
            mode: The mode in which `to_python` should run.
                If mode is 'json', the dictionary will only contain JSON serializable types.
                If mode is 'python', the dictionary may contain any Python objects.
            include: A list of fields to include in the output.
            exclude: A list of fields to exclude from the output.
            by_alias: Whether to use the field's alias in the dictionary key if defined.
            exclude_unset: Whether to exclude fields that have not been explicitly set.
            exclude_defaults: Whether to exclude fields that are set to their default value from the output.
            exclude_none: Whether to exclude fields that have a value of `None` from the output.
            round_trip: Whether to enable serialization and deserialization round-trip support.
            warnings: Whether to log warnings when invalid fields are encountered.
    
        Returns:
            A dictionary representation of the model.
        """
>       return self.__pydantic_serializer__.to_python(
            self,
            mode=mode,
            by_alias=by_alias,
            include=include,
            exclude=exclude,
            exclude_unset=exclude_unset,
            exclude_defaults=exclude_defaults,
            exclude_none=exclude_none,
            round_trip=round_trip,
            warnings=warnings,
        )
E       pydantic_core._pydantic_core.PydanticSerializationError: Unable to serialize unknown type: <class 'core.models.device.Device'>

/opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/main.py:308: PydanticSerializationError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-16T13:08:54.712903+00:00", "level": "WARNING", "logger": "middleware.permission_middleware", "message": "JWT decode failed: Not enough segments"}
ERROR: Unhandled exception: Unable to serialize unknown type: <class 'core.models.device.Device'>
Traceback: Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/tenant_context.py", line 84, in tenant_context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/fastapi_app/middleware.py", line 23, in request_id_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/permission_middleware.py", line 103, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/idempotency.py", line 23, in idempotency_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 292, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 180, in serialize_response
    return jsonable_encoder(response_content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/encoders.py", line 223, in jsonable_encoder
    obj_dict = _model_dump(
               ^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/_compat.py", line 177, in _model_dump
    return model.model_dump(mode=mode, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/main.py", line 308, in model_dump
    return self.__pydantic_serializer__.to_python(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.PydanticSerializationError: Unable to serialize unknown type: <class 'core.models.device.Device'>

{"timestamp": "2026-01-16T13:08:54.716318+00:00", "level": "ERROR", "logger": "x-ear", "message": "Unhandled exception: Unable to serialize unknown type: <class 'core.models.device.Device'>"}
{"timestamp": "2026-01-16T13:08:54.716381+00:00", "level": "ERROR", "logger": "x-ear", "message": "Traceback: Traceback (most recent call last):\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py\", line 98, in receive\n    return self.receive_nowait()\n           ^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py\", line 93, in receive_nowait\n    raise WouldBlock\nanyio.WouldBlock\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 78, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py\", line 118, in receive\n    raise EndOfStream\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py\", line 162, in __call__\n    await self.app(scope, receive, _send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/tenant_context.py\", line 84, in tenant_context_middleware\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py\", line 83, in __call__\n    await self.app(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/fastapi_app/middleware.py\", line 23, in request_id_middleware\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/permission_middleware.py\", line 103, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 108, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/idempotency.py\", line 23, in idempotency_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 84, in call_next\n    raise app_exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py\", line 70, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 79, in __call__\n    raise exc\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py\", line 68, in __call__\n    await self.app(scope, receive, sender)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py\", line 20, in __call__\n    raise e\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py\", line 17, in __call__\n    await self.app(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py\", line 718, in __call__\n    await route.handle(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py\", line 276, in handle\n    await self.app(scope, receive, send)\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py\", line 66, in app\n    response = await func(request)\n               ^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py\", line 292, in app\n    content = await serialize_response(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py\", line 180, in serialize_response\n    return jsonable_encoder(response_content)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/encoders.py\", line 223, in jsonable_encoder\n    obj_dict = _model_dump(\n               ^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/_compat.py\", line 177, in _model_dump\n    return model.model_dump(mode=mode, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/main.py\", line 308, in model_dump\n    return self.__pydantic_serializer__.to_python(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\npydantic_core._pydantic_core.PydanticSerializationError: Unable to serialize unknown type: <class 'core.models.device.Device'>\n"}
------------------------------ Captured log call -------------------------------
WARNING  middleware.permission_middleware:permission_middleware.py:68 JWT decode failed: Not enough segments
ERROR    x-ear:main.py:185 Unhandled exception: Unable to serialize unknown type: <class 'core.models.device.Device'>
ERROR    x-ear:main.py:186 Traceback: Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/tenant_context.py", line 84, in tenant_context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/fastapi_app/middleware.py", line 23, in request_id_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/permission_middleware.py", line 103, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/middleware/idempotency.py", line 23, in idempotency_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 292, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 180, in serialize_response
    return jsonable_encoder(response_content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/encoders.py", line 223, in jsonable_encoder
    obj_dict = _model_dump(
               ^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/fastapi/_compat.py", line 177, in _model_dump
    return model.model_dump(mode=mode, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/main.py", line 308, in model_dump
    return self.__pydantic_serializer__.to_python(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.PydanticSerializationError: Unable to serialize unknown type: <class 'core.models.device.Device'>
=============================== warnings summary ===============================
../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:252: 366 warnings
  /opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:252: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.5/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(

apps/api/schemas/inventory.py:63
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/schemas/inventory.py:63: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("ear", always=True, pre=True)

apps/api/schemas/inventory.py:67
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/schemas/inventory.py:67: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("kdv", always=True, pre=True)

apps/api/schemas/inventory.py:71
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/schemas/inventory.py:71: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("vat_included_price", always=True)

apps/api/schemas/appointments.py:79
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/schemas/appointments.py:79: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("type", always=True, pre=True)

../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
  /opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149: UserWarning: Field "model_id" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ()`.
    warnings.warn(

../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
  /opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149: UserWarning: Field "model_version" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ()`.
    warnings.warn(

../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
  /opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149: UserWarning: Field "model_available" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ()`.
    warnings.warn(

apps/api/routers/admin_tickets.py:37
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/routers/admin_tickets.py:37: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "created_at": datetime.utcnow().isoformat(),

apps/api/routers/admin_tickets.py:38
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/routers/admin_tickets.py:38: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "sla_due_date": datetime.utcnow().isoformat()

../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /opt/homebrew/anaconda3/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

../../../../../opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149
  /opt/homebrew/anaconda3/lib/python3.12/site-packages/pydantic/_internal/_fields.py:149: UserWarning: Field "model_provider" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ()`.
    warnings.warn(

tests/integration/test_response_standardization.py::test_user_me_response_structure
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:98: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user.last_login = datetime.utcnow()

tests/integration/test_response_standardization.py::test_user_me_response_structure
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:99: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user.created_at = datetime.utcnow()

tests/integration/test_response_standardization.py::test_user_me_response_structure
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:100: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user.updated_at = datetime.utcnow()

tests/integration/test_response_standardization.py::test_sales_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:129: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    sale_date=datetime.utcnow()

tests/integration/test_response_standardization.py::test_inventory_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:188: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow(),

tests/integration/test_response_standardization.py::test_inventory_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:189: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    updated_at=datetime.utcnow()

tests/integration/test_response_standardization.py::test_appointment_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:244: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow(),

tests/integration/test_response_standardization.py::test_appointment_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:245: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    updated_at=datetime.utcnow()

tests/integration/test_response_standardization.py::test_device_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:286: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow(),

tests/integration/test_response_standardization.py::test_device_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/integration/test_response_standardization.py:287: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    updated_at=datetime.utcnow()

tests/integration/test_response_standardization.py::test_device_response_standardization
  /Users/omerozmen/Desktop/x-ear web app/x-ear/apps/api/tests/conftest.py:53: SAWarning: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: device_assignments, sales; and backend does not support ALTER.  To restore at least a partial sort, apply use_alter=True to ForeignKey and ForeignKeyConstraint objects involved in the cycle to mark these as known cycles that will be ignored.
    Base.metadata.drop_all(bind=engine)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED apps/api/tests/integration/test_response_standardization.py::test_appointment_response_standardization
FAILED apps/api/tests/integration/test_response_standardization.py::test_device_response_standardization
================== 2 failed, 4 passed, 391 warnings in 0.59s ===================
