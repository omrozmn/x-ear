name: CI

on:
  push:
    branches: [main, dev, develop]
  pull_request:
    branches: [main, dev, develop]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '8'

jobs:
  # ============================================
  # FRONTEND CHECKS
  # ============================================
  
  typecheck:
    name: üî∑ TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd apps/web && pnpm install --frozen-lockfile
          cd ../.. && cd packages/ui-web && pnpm install --frozen-lockfile

      - name: TypeScript check
        run: cd apps/web && pnpm run type-check

  lint:
    name: üîç ESLint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd apps/web && pnpm install --frozen-lockfile
          cd ../.. && cd packages/ui-web && pnpm install --frozen-lockfile

      - name: Lint check (critical errors only)
        run: |
          cd apps/web
          # Use CI-specific config that only checks critical runtime errors
          # Warnings are for code quality issues that don't cause runtime bugs
          npx eslint . --ext ts,tsx -c .eslintrc.ci.cjs --max-warnings 100

  frontend-tests:
    name: üß™ Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd apps/web && pnpm install --frozen-lockfile
          cd ../.. && cd packages/ui-web && pnpm install --frozen-lockfile

      - name: Run tests
        run: |
          cd apps/web
          pnpm run test --run --reporter=verbose
        continue-on-error: true  # TODO: Remove when tests are stable

  build:
    name: üèóÔ∏è Build Check
    runs-on: ubuntu-latest
    needs: [typecheck, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd apps/web && pnpm install --frozen-lockfile
          cd ../.. && cd packages/ui-web && pnpm install --frozen-lockfile

      - name: Build web app
        run: cd apps/web && pnpm run build

      - name: Verify build output
        run: |
          if [ -d "apps/web/dist" ]; then
            echo "‚úÖ Build successful - dist folder exists"
            ls -la apps/web/dist
          else
            echo "‚ùå Build failed - dist folder not found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist
          retention-days: 7

  # ============================================
  # BACKEND CHECKS
  # ============================================

  backend-lint:
    name: üêç Python Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd apps/backend
          pip install -r requirements.txt
          pip install ruff

      - name: Run Ruff linter
        run: |
          cd apps/backend
          ruff check . --ignore E501,F401,F841 --exclude tests/,migrations/,__pycache__/ || echo "Lint warnings found"
        continue-on-error: true  # TODO: Fix lint errors and make blocking

  backend-tests:
    name: üß™ Backend Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd apps/backend
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          TESTING: "true"
          SECRET_KEY: test-secret-key-for-ci
        run: |
          cd apps/backend
          python -m pytest tests/ -v --tb=short -x --ignore=tests/__pycache__/ || echo "Some tests failed"
        continue-on-error: true  # TODO: Remove when tests are stable

  # ============================================
  # API CONTRACT CHECKS
  # ============================================

  api-sync-check:
    name: üîÑ API Sync Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Python dependencies
        run: |
          cd apps/backend
          pip install -r requirements.txt

      - name: Install web dependencies
        run: |
          cd apps/web
          pnpm install --frozen-lockfile

      - name: Generate OpenAPI spec
        run: |
          cd apps/backend
          python scripts/generate_openapi.py || echo "OpenAPI generation skipped"

      - name: Check if API types are in sync
        run: |
          cd apps/web
          pnpm run gen:api || echo "API generation completed"
          if git diff --exit-code src/api/generated/; then
            echo "‚úÖ API types are in sync"
          else
            echo "‚ö†Ô∏è API types are out of sync - run 'npm run gen:api' locally"
            exit 1
          fi

  # ============================================
  # SECURITY CHECKS
  # ============================================

  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Check for npm audit issues
        run: |
          cd apps/web
          pnpm audit --audit-level=high || echo "Security vulnerabilities found"
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          # Simple check for common secret patterns
          if grep -rE "(password|secret|api_key|apikey|token)\s*=\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.py" apps/ --exclude-dir=node_modules --exclude-dir=__pycache__ --exclude-dir=.venv 2>/dev/null | grep -v "process.env" | grep -v "os.environ" | grep -v "test" | grep -v "example" | head -20; then
            echo "‚ö†Ô∏è Potential hardcoded secrets found - please review"
          else
            echo "‚úÖ No obvious hardcoded secrets found"
          fi
        continue-on-error: true

  # ============================================
  # FINAL GATE
  # ============================================

  ci-passed:
    name: ‚úÖ CI Passed
    runs-on: ubuntu-latest
    needs: [typecheck, lint, build, api-sync-check]
    if: always()
    steps:
      - name: Check all required jobs
        run: |
          if [ "${{ needs.typecheck.result }}" != "success" ]; then
            echo "‚ùå TypeScript check failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "‚ùå Lint check failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          if [ "${{ needs.api-sync-check.result }}" != "success" ]; then
            echo "‚ùå API sync check failed"
            exit 1
          fi
          echo "‚úÖ All required CI checks passed!"
